# å¦‚ä½•ä½¿ç”¨ Prometheus & Grafana ç›‘æ§ Docker æŒ‡æ ‡ï¼Ÿ

> åŸæ–‡ï¼š<https://medium.com/geekculture/how-to-monitor-docker-metrics-using-prometheus-grafana-707b970f1f06?source=collection_archive---------1----------------------->

**æ™®ç½—ç±³ä¿®æ–¯æ˜¯ä»€ä¹ˆï¼Ÿ** Prometheus æ˜¯ä¸€æ¬¾å¼€æºç›‘æ§å·¥å…·ï¼Œä¸»è¦ç”¨äºæŒ‡æ ‡ç›‘æ§ã€äº‹ä»¶ç›‘æ§ã€å‘Šè­¦é…ç½®ç­‰ã€‚Prometheus è®¾è®¡ç”¨äºç›‘æ§ç›®æ ‡ã€æœåŠ¡å™¨ã€æ•°æ®åº“ã€ç‹¬ç«‹è™šæ‹Ÿæœºç­‰ã€‚Prometheus ä½¿ç”¨ä¸€ç§å«åš**â€œPromQLâ€çš„å¼ºå¤§æŸ¥è¯¢è¯­è¨€ã€‚**

![](img/bcf02159b545b240d96abebafb7839d2.png)

Prometheus Logo

**æ™®ç½—ç±³ä¿®æ–¯é…ç½®æ–‡ä»¶å’Œç»„ä»¶:**

*   **prometheus.yml:-** è¿™æ˜¯ prometheus çš„é…ç½®æ–‡ä»¶ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨å…¶ä¸­å¯¹ Prometheus çš„é…ç½®è¿›è¡Œæ‰€æœ‰æ›´æ”¹ã€‚
*   **Promtool:-** å®ƒæ˜¯ç”¨äºéªŒè¯ Prometheus é…ç½®çš„å‘½ä»¤è¡Œå®ç”¨å·¥å…·ã€‚
*   **PromQL:-** å®ƒæ˜¯ Prometheus ä½¿ç”¨çš„å¼ºæŸ¥è¯¢è¯­è¨€ã€‚

**Grafana æ˜¯ä»€ä¹ˆï¼ŸGrafana æ˜¯ä¸€ä¸ªå…è´¹çš„å¼€æºå¯è§†åŒ–å·¥å…·ï¼Œå®ƒä¸ºç‰¹å®šçš„æ•°æ®æºæä¾›äº†å„ç§ä»ªè¡¨æ¿ã€å›¾è¡¨ã€å›¾å½¢å’Œè­¦å‘Šã€‚Grafana å…è®¸æˆ‘ä»¬æŸ¥è¯¢ã€å¯è§†åŒ–ã€æ¢ç´¢æŒ‡æ ‡å¹¶ä¸ºæ•°æ®æºè®¾ç½®è­¦æŠ¥ã€‚æˆ‘ä»¬è¿˜å¯ä»¥åˆ›å»ºè‡ªå·±çš„åŠ¨æ€ä»ªè¡¨æ¿è¿›è¡Œå¯è§†åŒ–å’Œç›‘æ§ã€‚æˆ‘ä»¬å¯ä»¥ä¿å­˜ä»ªè¡¨æ¿ï¼Œå¹¶ä¸å…¶ä»–æˆå‘˜å…±äº«ã€‚æˆ‘ä»¬è¿˜å¯ä»¥å¯¼å…¥å¤–éƒ¨ä»ªè¡¨æ¿ã€‚**

![](img/70b3d838c16cccc4af21df9edc4d1114.png)

Grafana Logo

åœ¨æœ¬æ•™ç¨‹ä¸­ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ **Prometheus** å’Œ **Grafana** ç›‘æ§å„ç§ docker æŒ‡æ ‡

![](img/cebfe1a9ec92a6905ddee82d67e671ef.png)

Docker metrics monitoring with Prometheus & Grafana

**å…ˆå†³æ¡ä»¶:-**

*   **æ™®ç½—ç±³ä¿®æ–¯** & **æ ¼æ‹‰å¤«çº³**çš„åŸºæœ¬æ¦‚å†µ
*   AWS å¸æˆ·
*   ä¸€ä¸ªå®‰è£…äº† **Docker** å’Œä¸€äº›**å®¹å™¨**çš„æœåŠ¡å™¨

ç°åœ¨ï¼Œè®©æˆ‘ä»¬å¼€å§‹é…ç½®é¡¹ç›®ã€‚

**æ­¥éª¤ 1:-åˆ›å»ºæœåŠ¡å™¨**

*   åœ¨æœ¬æ•™ç¨‹ä¸­ï¼Œæˆ‘å·²ç»åˆ›å»ºäº† Ubuntu 20.04 AMI çš„æœåŠ¡å™¨
*   åœ¨ **AWS** ä¸­åˆ›å»º **Ubuntu 20.04** æœåŠ¡å™¨ã€‚åœ¨è¿™ä¸ªæœåŠ¡å™¨ä¸­ï¼Œæˆ‘ä»¬å°†å®‰è£…æ™®ç½—ç±³ä¿®æ–¯
*   å¯¹äº **Prometheus & Grafana** æœåŠ¡å™¨ï¼Œæˆ‘ä»¬éœ€è¦ä¸º SSH æ‰“å¼€**9090**&**3000**port&port**22**

![](img/0a5041de90a7ae737cba73f17290a493.png)

Servers

**æ­¥éª¤ 2:-å®‰è£…æ™®ç½—ç±³ä¿®æ–¯**

*   ä»è¿™ä¸ª [**é“¾æ¥**ä¸‹è½½ Prometheus å¹¶å®‰è£…åœ¨æœåŠ¡å™¨ä¸Šã€‚](https://prometheus.io/download/#node_exporter)
*   ä¸ºäº†å¯åŠ¨æ™®ç½—ç±³ä¿®æ–¯ï¼Œæˆ‘ä»¬éœ€è¦åœ¨æ™®ç½—ç±³ä¿®æ–¯ç›®å½•ä¸­è¿è¡Œ`./prometheus`
*   æˆ‘ä»¬å¯ä»¥åœ¨ **<å…¬å…± IP:9090 >** æŸ¥çœ‹**æ™®ç½—ç±³ä¿®æ–¯**çš„ UI

![](img/f04882f3fd6a5bc9bce602594858dfe6.png)

Prometheus UI

**æ­¥éª¤ 3:-å®‰è£… Grafana**

*   ä»è¿™ä¸ª [**é“¾æ¥**](https://prometheus.io/download/#node_exporter) ä¸‹è½½ Grafana å¹¶å®‰è£…åœ¨æˆ‘ä»¬å®‰è£… Prometheus çš„åŒä¸€å°æœåŠ¡å™¨ä¸Š
*   ä¸ºäº†å¯åŠ¨ Grafanaï¼Œæˆ‘ä»¬éœ€è¦ä» Grafana ç›®å½•è¿è¡Œ`./bin/grafana-server`å‘½ä»¤
*   å½“ä½ ç¬¬ä¸€æ¬¡æ‰“å¼€ Grafana çš„ç”¨æˆ·ç•Œé¢æ—¶ï¼Œå®ƒä¼šè¦æ±‚è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ã€‚é»˜è®¤ç”¨æˆ·åå’Œå¯†ç æ˜¯ **adminã€‚**æ‚¨å¯ä»¥ç¨åæ›´æ”¹å¯†ç 
*   æˆ‘ä»¬å¯ä»¥åœ¨ **<å…¬å…± IP: 3000 >** æŸ¥çœ‹ Grafana çš„ UI

![](img/1f40ec4a05259b7a46000783f0b38429.png)

Grafana UI

**æ­¥éª¤ 4:-ä¿®æ”¹ daemon.json æ–‡ä»¶**

*   ä¸ºäº†è®© Prometheus æ”¶é›† docker çš„æŒ‡æ ‡ï¼Œæˆ‘ä»¬éœ€è¦åœ¨ docker æœåŠ¡å™¨çš„`/etc/docker/daemon.json`æ–‡ä»¶ä¸­æ·»åŠ ä¸‹é¢çš„èŠ‚ã€‚

```
{
  "metrics-addr" : "127.0.0.1:9323",
  "experimental" : true
}
```

*   **9323** æ˜¯æ™®ç½—ç±³ä¿®æ–¯æ”¶é›†æŒ‡æ ‡çš„ç«¯å£
*   æ·»åŠ å®Œä¸Šé¢çš„éƒ¨åˆ†åï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤é‡å¯ docker

```
systemctl restart docker
```

*   æˆ‘ä»¬å¯ä»¥åœ¨ **<å…¬å…± IP:9393/metrics >** æŸ¥çœ‹ä¸åŒçš„æŒ‡æ ‡

![](img/3b06e63432d5ff26e174c1cec81ce559.png)

Metrics

*   å¦‚æœä¸Šé¢çš„è®¾ç½®ä¸èµ·ä½œç”¨ï¼Œé‚£ä¹ˆæˆ‘ä»¬ä¹Ÿå¯ä»¥åœ¨`daemon.json`æ–‡ä»¶ä¸­æ·»åŠ ä¸‹é¢çš„éƒ¨åˆ†ã€‚

```
{
  "metrics-addr" : "0.0.0.1:9323",
  "experimental" : true
}
```

**æ­¥éª¤ 5:-ä¿®æ”¹æ™®ç½—ç±³ä¿®æ–¯çš„é…ç½®æ–‡ä»¶**

*   Prometheus ç®¡ç†åä¸º **prometheus.yml** çš„é…ç½®æ–‡ä»¶ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨å…¶ä¸­å®šä¹‰å„ç§é…ç½®ï¼Œå¦‚**è­¦æŠ¥ã€scrape_configs** ç­‰ã€‚
*   ä¸ºäº†è®© Prometheus æ”¶é›† Docker èŠ‚ç‚¹çš„æŒ‡æ ‡ï¼Œæˆ‘ä»¬éœ€è¦åœ¨ **scrape_configs** èŠ‚ä¸‹çš„ **prometheus.yml** ä¸­å®šä¹‰ä»¥ä¸‹ä»£ç 

```
- job_name: "Docker Job"
  static_configs:
    - targets: ["<Public IP of Docker Node:9323"]
```

*   æ·»åŠ ä»£ç åï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ Prometheus ä¸­å°†æˆ‘ä»¬çš„èŠ‚ç‚¹ä½œä¸ºç›®æ ‡è¿›è¡Œæ£€æŸ¥ã€‚Prometheus éœ€è¦ä¸€äº›æ—¶é—´æ¥æ”¶é›†æ‰€æœ‰æŒ‡æ ‡å¹¶æ˜¾ç¤ºèŠ‚ç‚¹åˆ° **Up** çš„çŠ¶æ€ã€‚

![](img/ddb6c2ae9d1e095c6be575c0fb206c60.png)

Targets

**æ­¥éª¤ 6:-åœ¨ Grafana ä¸­æ·»åŠ æ•°æ®æº**

*   ç°åœ¨ï¼Œåœ¨ Grafana ä¸­ï¼Œæˆ‘ä»¬éœ€è¦æ·»åŠ  Prometheus ä½œä¸ºæ•°æ®æº
*   ä¹‹åï¼Œåœ¨çš„ URL éƒ¨åˆ†æˆ‘ä»¬éœ€è¦è¾“å…¥ Prometheus æœåŠ¡å™¨çš„ IP åœ°å€å’Œ **9090** ç«¯å£

![](img/d8b07ad0e1d0d3bbf0c10fd6ee6a4bcd.png)

Data Sources

**ç¬¬ 7 æ­¥:-åˆ›å»ºä»ªè¡¨æ¿**

*   åœ¨ Grafana ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥æ ¹æ®éœ€è¦åˆ›å»ºå„ç§ä»ªè¡¨æ¿ã€‚
*   å› æ­¤ï¼Œåœ¨æœ¬æ•™ç¨‹ä¸­ï¼Œæˆ‘ä»¬å°†åˆ›å»ºä¸€ä¸ªåŒ…å« 3 ä¸ªé¢æ¿çš„ä»ªè¡¨æ¿ã€‚
*   ç¬¬ä¸€ä¸ªé¢æ¿å°†æ˜¾ç¤º**è¿è¡Œå®¹å™¨**çš„æ•°é‡ï¼Œç¬¬äºŒä¸ªé¢æ¿å°†æ˜¾ç¤º**æš‚åœå®¹å™¨**çš„æ•°é‡ï¼Œæœ€åä¸€ä¸ªé¢æ¿å°†æ˜¾ç¤º**åœæ­¢å®¹å™¨**çš„æ•°é‡ã€‚
*   ç‚¹å‡»**åˆ›å»º** - >æ·»åŠ **é¢æ¿**
*   åœ¨â€œæŒ‡æ ‡æµè§ˆå™¨â€éƒ¨åˆ†ï¼Œåœ¨ä¸‹é¢æ·»åŠ æŸ¥è¯¢ã€‚ä»¥ä¸‹æŸ¥è¯¢å°†è·å–**åœæ­¢é›†è£…ç®±**çš„æ•°é‡ã€‚

```
engine_daemon_container_states_containers{state="stopped"}
```

*   æ‚¨å¯ä»¥å°†å¯è§†åŒ–æ›´æ”¹ä¸º**çŠ¶æ€**

![](img/731a14f72f54cc72e8600c227eb02259.png)

Stopped Containers

*   ç‚¹å‡»**æ·»åŠ é¢æ¿**æ·»åŠ ç¬¬äºŒä¸ªé¢æ¿
*   åœ¨â€œæŒ‡æ ‡æµè§ˆå™¨â€éƒ¨åˆ†ï¼Œåœ¨ä¸‹é¢æ·»åŠ æŸ¥è¯¢ã€‚ä»¥ä¸‹æŸ¥è¯¢å°†è·å–**æš‚åœé›†è£…ç®±**çš„æ•°é‡

```
engine_daemon_container_states_containers{state="paused"}
```

![](img/6cf5c61b40091fab679a4bd295bcd2a3.png)

Paused containers

*   ç‚¹å‡»**æ·»åŠ é¢æ¿**æ·»åŠ ç¬¬äºŒä¸ªé¢æ¿
*   åœ¨â€œæŒ‡æ ‡æµè§ˆå™¨â€éƒ¨åˆ†ï¼Œåœ¨ä¸‹é¢æ·»åŠ æŸ¥è¯¢ã€‚ä¸‹é¢çš„æŸ¥è¯¢å°†è·å–æ­£åœ¨è¿è¡Œçš„å®¹å™¨**çš„æ•°é‡**

```
engine_daemon_container_states_containers{state="running"}
```

![](img/6eb27ca71427856038009d5dc85fb81a.png)

Running Containers

*   å•å‡»â€œä¿å­˜ä»ªè¡¨æ¿â€æŒ‰é’®ä¿å­˜ä»ªè¡¨æ¿ï¼Œå¹¶ä¸ºå…¶é€‰æ‹©ä¸€ä¸ªåç§°
*   ä»ªè¡¨æ¿çš„æœ€ç»ˆç»“æœå°†å¦‚ä¸‹æ‰€ç¤º:

![](img/edfcb4a34f62c05c58fd5020ab0fca64.png)

Dashboard

*   æ‚¨å¯ä»¥æ›´æ”¹ä»ªè¡¨æ¿è‡ªåŠ¨åŠ è½½çš„æ—¶é—´é¢‘ç‡ã€‚åœ¨æˆ‘çš„ä¾‹å­ä¸­ï¼Œæˆ‘å°†å®ƒè®¾ç½®ä¸º 5mã€‚

å°±æ˜¯è¿™æ ·ã€‚æ‚¨å·²ç»å­¦ä¹ äº†å¦‚ä½•ä½¿ç”¨ **Prometheus** å’Œ **Grafana** ç›‘æ§ Docker æŒ‡æ ‡ã€‚

ä½ å¯ä»¥é€šè¿‡è®¿é—®ä¸‹é¢çš„ç½‘å€æ¥æ¢ç´¢æ›´å¤šå…³äºæ™®ç½—ç±³ä¿®æ–¯å’Œæ ¼æ‹‰å¤«çº³çš„ä¿¡æ¯ã€‚

*   [https://prometheus.io/docs/introduction/overview/](https://prometheus.io/docs/introduction/overview/)
*   [https://grafana.com/](https://grafana.com/)

å¦‚æœæ‚¨å‘ç°æ­¤æŒ‡å—æœ‰å¸®åŠ©ï¼Œè¯·ç‚¹å‡»ğŸ‘æŒ‰é’®ï¼Œä¹Ÿå¯ä»¥éšæ„å‘è¡¨è¯„è®ºã€‚

å…³æ³¨æ›´å¤šç±»ä¼¼çš„æ•…äº‹ğŸ˜Š