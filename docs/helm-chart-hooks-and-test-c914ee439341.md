# èˆµ-æµ·å›¾é’©å’Œæµ‹è¯•

> åŽŸæ–‡ï¼š<https://medium.com/geekculture/helm-chart-hooks-and-test-c914ee439341?source=collection_archive---------3----------------------->

## èˆµé’©é…ç½®å’Œèˆµé‡Šæ”¾æµ‹è¯•

![](img/1769d1a284d9342cb40a4355c88a0d78.png)

Photo by [Andrew Ridley](https://unsplash.com/@aridley88?utm_source=medium&utm_medium=referral) on [Unsplash](https://unsplash.com?utm_source=medium&utm_medium=referral)

**ä¸Šä¸€ç¯‡:** [**èµ«å°”å§†â€”çˆ¶å­å›¾è¡¨é—´çš„æ•°æ®å…±äº«**](/gitconnected/helm-data-sharing-between-parent-and-child-chart-c4487a452d4e)

Helm ä¸ºæˆ‘ä»¬æä¾›äº†ä¸€ä¸ªå›¾è¡¨æœºåˆ¶ï¼Œå…è®¸æˆ‘ä»¬åœ¨ä¸€ä¸ªç‰ˆæœ¬çš„ç”Ÿå‘½å‘¨æœŸä¸­çš„æŸäº›ç‚¹è¿›è¡Œå¹²é¢„ã€‚ä¾‹å¦‚ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨é’©å­æ¥:

â—åœ¨å®‰è£…è¿‡ç¨‹ä¸­ç¡®å®šä»»åŠ¡çš„ä¼˜å…ˆé¡ºåºã€‚ä¾‹å¦‚ï¼Œåœ¨åŠ è½½å›¾è¡¨çš„ä»»ä½•å…¶ä»–ç»„ä»¶ä¹‹å‰åŠ è½½é…ç½®æ˜ å°„æˆ–ç§˜å¯†ã€‚

â—åœ¨å®‰è£…/å‡çº§æ–°å›¾è¡¨æˆ–åœ¨å‡çº§åŽæ¢å¤æ•°æ®åº“ä¹‹å‰ï¼Œå¤‡ä»½æ•°æ®åº“ã€‚

é’©å­æ–‡ä»¶çœ‹èµ·æ¥ç±»ä¼¼äºŽå¸®åŠ©æˆ‘ä»¬ç”Ÿæˆ kubernetes æ¸…å•çš„æ¨¡æ¿æ–‡ä»¶ã€‚é™¤äº†ä¸€äº›ç‰¹æ®Šçš„æ³¨é‡Šã€‚å‡è®¾æˆ‘ä»¬æƒ³åœ¨è¿›è¡Œä»»ä½•å…¶ä»–å®‰è£…ä¹‹å‰åŠ è½½ä¸€ä¸ª kubernetes ConfigMapã€‚å¸¦æœ‰æŒ‚é’©çš„æ¨¡æ¿å°†å¦‚ä¸‹æ‰€ç¤º:

```
# mychart/template/hookConfigMap.yamlapiVersion: v1
kind: ConfigMap
metadata:
  creationTimestamp: null
  name: test
  labels:
    app: webserver
    app.kubernetes.io/managed-by: Helm
 **annotations: 
   "helm.sh/hook": pre-install
   "helm.sh/hook-weight": "5"
   "helm.sh/hook-delete-policy": before-hook-creation**
data:
  name: nginx
```

åœ¨ä¸Šé¢çš„æ¼”ç¤ºä¸­ï¼Œå®šä¹‰äº†ä¸€äº›**æ³¨é‡Š**ã€‚è¿™äº›æ³¨é‡Šç”¨äºŽé…ç½®èˆµé’©ã€‚

è®©æˆ‘ä»¬åœ¨æŽ¥ä¸‹æ¥çš„éƒ¨åˆ†ä¸­è®¨è®ºæ¯ä¸ªæ³¨é‡Šçš„ä½œç”¨:

## helm.sh/hook

`**helm.sh/hook**`æ³¨é‡Šå®šä¹‰äº†é’©å­ã€‚åœ¨ä¸Šé¢çš„æ¼”ç¤ºä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨äº†`**pre-install**` é’©å­ï¼Œè¿™æ„å‘³ç€ ConfigMap å°†åœ¨å…¶ä»–å®‰è£…å‘ç”Ÿä¹‹å‰åŠ è½½ã€‚

æœ‰å¤šç§æŒ‚é’©å¯ä¾›é€‰æ‹©:

```
**pre-install** **post-install** **pre-delete** **post-delete****pre-upgrade****post-upgrade** **pre-rollback** **post-rollback****test**
```

ä¸Šé¢å®šä¹‰çš„é’©å­å®žé™…ä¸Šæè¿°äº†å®ƒçš„ä½œç”¨ã€‚æ¬²äº†è§£æ›´å¤šè¯¦æƒ…ï¼Œè¯·é˜…è¯» helm å®˜æ–¹æ–‡æ¡£ä¸­çš„æœ¬éƒ¨åˆ†[](https://helm.sh/docs/topics/charts_hooks/#the-available-hooks)**ã€‚åœ¨æ‰€æœ‰é’©å­ä¸­ï¼Œæˆ‘ä»¬å°†åœ¨æœ€åŽéƒ¨åˆ†è®¨è®º**ã€æµ‹è¯•ã€‘**é’©å­ã€‚**

**å¦‚æžœéœ€è¦ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥å°†å¤šä¸ªæŒ‚é’©ç»“åˆä½¿ç”¨:**

```
annotations: 
   "helm.sh/hook": **pre-install, pre-delete, post-rollback**
```

## ****helm.sh/hook-weight****

**å¯ä»¥ä¸ºä¸€ä¸ªé’©å­å®šä¹‰ä¸€ä¸ªæƒé‡ï¼Œè¿™å°†æœ‰åŠ©äºŽå»ºç«‹ä¸€ä¸ªç¡®å®šçš„æ‰§è¡Œé¡ºåºã€‚ä½¿ç”¨ä»¥ä¸‹æ³¨é‡Šå®šä¹‰æƒé‡:**

```
**annotations**:
  **"helm.sh/hook-weight":** "5"
```

****åŠé’©é‡é‡å¯ä»¥æ˜¯æ­£æ•°æˆ–è´Ÿæ•°ï¼Œä½†å¿…é¡»ç”¨å­—ç¬¦ä¸²**è¡¨ç¤ºã€‚å½“ Helm å¯åŠ¨ä¸€ä¸ªç‰¹å®šç±»åž‹é’©å­çš„æ‰§è¡Œå‘¨æœŸæ—¶ï¼Œå®ƒä¼šå°†è¿™äº›é’©å­æŒ‰å‡åºæŽ’åºã€‚**

**å‡è®¾æˆ‘ä»¬æœ‰ä¸¤ä¸ªæŒ‡å®šäº†â€œé¢„å®‰è£…â€æŒ‚é’©çš„ä¸åŒæ¨¡æ¿ã€‚å®ƒä»¬ä¸­çš„æ¯ä¸€ä¸ªéƒ½é…ç½®æœ‰ä¸åŒçš„â€œ**é’©é‡â€ã€‚****

```
# templates/hooks1.yamlannotations:
  "helm.sh/hook": **pre-install**
  "helm.sh/hook-weight": **"-1"** ---
# templates/hooks2.yamlannotations:
  "helm.sh/hook": **pre-install**
  "helm.sh/hook-weight": **"-5"**
```

**åœ¨ä¸Šé¢çš„æ¼”ç¤ºä¸­ï¼Œå¸¦'- **5'** çš„åŠé’©é‡é‡å°†é¦–å…ˆæ‰§è¡Œï¼Œå› ä¸ºèˆµå°†æŒ‰å‡åºå¯¹æ‰€æœ‰åŠé’©è¿›è¡ŒæŽ’åºã€‚**

## ****helm.sh/hook-delete-policy****

**æœ‰ä¸‰ç§ç±»åž‹çš„åˆ é™¤ç­–ç•¥ã€‚**

> **`**before-hook-creation**` *â€”åœ¨ä¸€ä¸ªæ–°çš„æŒ‚é’©å¯åŠ¨ä¹‹å‰åˆ é™¤ä»¥å‰çš„èµ„æº(é»˜è®¤)ã€‚* `**hook-succeeded**` *â€”é’©å­æ‰§è¡ŒæˆåŠŸåŽåˆ é™¤èµ„æºã€‚* `***hook-failed***` *â€”å¦‚æžœé’©å­æ‰§è¡Œå¤±è´¥ï¼Œåˆ é™¤èµ„æºã€‚***

## **èˆµè¯•éªŒ**

**æœ‰ä¸€ç§èˆµé’©å«â€œæµ‹è¯•â€ã€‚ä½¿ç”¨â€œtestâ€é’©å­ï¼Œæˆ‘ä»¬å¯ä»¥æµ‹è¯•æˆ‘ä»¬çš„å‘å¸ƒã€‚èˆµæµ‹è¯•å‘½ä»¤å°†é‡Šæ”¾ä½œä¸ºè¾“å…¥ã€‚å› æ­¤ï¼Œä¸ºäº†æµ‹è¯•æˆ‘ä»¬çš„å›¾è¡¨ï¼Œæˆ‘ä»¬å¿…é¡»äº‹å…ˆå®‰è£…å›¾è¡¨ã€‚ç„¶åŽæˆ‘ä»¬å¯ä»¥è¿è¡Œ **helm test** å‘½ä»¤æ¥æµ‹è¯•æˆ‘ä»¬çš„å‘å¸ƒã€‚**

**æ‰€æœ‰çš„æµ‹è¯•æ–‡ä»¶éƒ½ä½äºŽ**â€œå›¾è¡¨å/æ¨¡æ¿/æµ‹è¯•â€**ç›®å½•ä¸‹ã€‚è®©æˆ‘ä»¬çœ‹ä¸€ä¸ªæµ‹è¯•æ¨¡æ¿æ–‡ä»¶:**

```
**# chartName/templates/tests/test-connection.yaml**apiVersion: v1
kind: Pod
metadata:
  name: "{{ include "webserver.fullname" . }}-test-connection"
  labels:
    {{- include "webserver.labels" . | nindent 4 }}
 **annotations:
    "helm.sh/hook": test**
spec:
  containers:
    - name: wget
      image: busybox
      command: ['wget']
      args: ['{{ include "webserver.fullname" . }}:{{ .Values.service.port }}']
  restartPolicy: Never
```

**åœ¨ä¸Šé¢çš„æ¼”ç¤ºä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°å®šä¹‰äº†ä¸€ä¸ª" t **est"** ç±»åž‹çš„é’©å­ã€‚å°½ç®¡å®ƒæ˜¯ä¸€ä¸ª podï¼Œä½†å®ƒä¸ä¼šåœ¨å›¾è¡¨çš„å®‰è£…é˜¶æ®µå®‰è£…ã€‚åªæœ‰å½“æˆ‘ä»¬ä½¿ç”¨**èˆµæµ‹è¯•**å‘½ä»¤è§¦å‘å®ƒæ—¶ï¼Œå®ƒæ‰ä¼šè¢«å®‰è£…ã€‚æ­¤ pod å°†æµ‹è¯• pod å’Œä¸Šè¿°æ¨¡æ¿æ–‡ä»¶ä¸­æŒ‡å®šçš„ç‰¹å®šæœåŠ¡ä¹‹é—´çš„è¿žæŽ¥ã€‚è¿˜æœ‰å…¶ä»–ä¸€äº›ç”¨ä¾‹ï¼Œä¾‹å¦‚ï¼Œåœ¨éƒ¨ç½²æ•°æ®åº“æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥æ£€æŸ¥æ•°æ®åº“å¯†ç è®¾ç½®æ˜¯å¦æ­£ç¡®ã€‚**

**ä¸Šé¢çš„æµ‹è¯•æ¨¡æ¿æ–‡ä»¶æ¥è‡ª nginx å›¾è¡¨ã€‚è®©æˆ‘ä»¬å®‰è£…å®ƒï¼Œçœ‹çœ‹ä¼šå‘ç”Ÿä»€ä¹ˆ:**

```
**>>**  helm install webserver webserver/
```

**çŽ°åœ¨æˆ‘ä»¬å°†ä½¿ç”¨**èˆµæµ‹è¯•**å‘½ä»¤æµ‹è¯•æˆ‘ä»¬çš„å‘å¸ƒ:**

```
 helm test **[ RELEASE ]**
>> helm test  webserver--------------------------------------------------------------------
**NAME: webserver**
LAST DEPLOYED: Mon Oct 31 07:29:44 2022
NAMESPACE: default
STATUS: deployed
REVISION: 1
TEST SUITE:     webserver-test-connection
Last Started:   Mon Oct 31 07:30:08 2022
Last Completed: Mon Oct 31 07:30:15 2022
**Phase:          Succeeded**
```

**åœ¨ä¸Šé¢çš„æ¼”ç¤ºä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°æˆ‘ä»¬çš„æµ‹è¯•æˆåŠŸäº†ã€‚ä¸ºäº†è¿›è¡Œæµ‹è¯•ï¼Œéƒ¨ç½²äº†ä¸€ä¸ªåä¸ºâ€œ**web server-test-connection**â€çš„ podã€‚å¹¶ä¸”å¤„äºŽ**å®Œæˆ**çŠ¶æ€ã€‚**

```
**>>** kubectl get pods NAME                         READY   STATUS      RESTARTS
webserver-test-connection    0/1    ** Completed  ** 0 
```

**çŽ°åœ¨ï¼Œé‡è¦çš„æ˜¯è¦æ³¨æ„ã€‚å¦‚æžœæˆ‘ä»¬å¸è½½æˆ‘ä»¬çš„ç‰ˆæœ¬ï¼Œé™¤äº†ä¸ºæµ‹è¯•éƒ¨ç½²çš„ pod(**web server-test-connection**)ä¹‹å¤–ï¼Œæ‰€æœ‰ä¸Žè¯¥ç‰ˆæœ¬ç›¸å…³çš„èµ„æºéƒ½å°†è¢«åˆ é™¤ã€‚è¦åœ¨æµ‹è¯•æˆåŠŸåŽåˆ é™¤ç›¸åº”çš„æµ‹è¯• podï¼Œæˆ‘ä»¬å¯ä»¥åœ¨æµ‹è¯•æ¨¡æ¿æ–‡ä»¶ä¸­æ·»åŠ å¦ä¸€ä¸ªæ³¨é‡Š`**helm.sh/hook-delete-policy: hook-succeeded**` ã€‚**

> ***å¦‚æžœä½ è§‰å¾—è¿™ç¯‡æ–‡ç« å¾ˆæœ‰å¸®åŠ©ï¼Œè¯·ä¸è¦å¿˜è®°***åŽ»ç‚¹å‡»* ***è·Ÿéš*** *ðŸ‘‰* *å’Œ* ***æ‹æ‰‹*** *ðŸ‘* *æŒ‰é’®å¸®åŠ©æˆ‘å†™æ›´å¤šè¿™æ ·çš„æ–‡ç« ã€‚
> è°¢è°¢ðŸ–¤****

## ****ðŸ‘‰*æ‰€æœ‰å…³äºŽå¤´ç›”çš„æ–‡ç« â€”***

***![Md Shamim](img/b46bdc53005abde6c6cb3e8ff0c200c3.png)

[Md æ²™ç±³å§†](/@shamimice03?source=post_page-----c914ee439341--------------------------------)*** 

## ***Helmãƒ¼Series***

***[View list](/@shamimice03/list/helmseries-6e2076d48ba8?source=post_page-----c914ee439341--------------------------------)******11 stories******![](img/9ba5df61339b6f5d2ad01696050835e3.png)******![](img/74e4f8812ce0aceba2616e176b3021c2.png)******![](img/a734d6746ba78eda4d8d1347c4231bae.png)***