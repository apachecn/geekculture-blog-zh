# ä½¿ç”¨ ML.Net æ—¶é—´åºåˆ—åº“è¿›è¡Œå¼‚å¸¸æ£€æµ‹å’Œé¢„æµ‹

> åŸæ–‡ï¼š<https://medium.com/geekculture/anomaly-detection-and-prediction-using-ml-net-timeseries-library-e91838ca0ba3?source=collection_archive---------5----------------------->

æœ‰è®¸å¤šæ–¹æ³•å¯ä»¥åœ¨è½¯ä»¶æœåŠ¡ä¸­åˆ©ç”¨äººå·¥æ™ºèƒ½ï¼Œå°¤å…¶æ˜¯åœ¨å•†ä¸šæ™ºèƒ½ä¸­ã€‚ML.Net å¾®è½¯å…¬å¸çš„æœºå™¨å­¦ä¹ åº“æœ‰è®¸å¤šç®—æ³•ï¼Œå®ƒçš„æ€§èƒ½æ—¥ç›Šæ”¹å–„ï¼Œå¯ä»¥å¸®åŠ©æˆ‘ä»¬åœ¨è¿™äº›æ–¹é¢å‰è¿›ã€‚å¼‚å¸¸æ£€æµ‹æ˜¯è¿™äº›æŠ€æœ¯ä¸­æœ€é‡è¦å’Œæœ€å¸¸ç”¨çš„æŠ€æœ¯ä¹‹ä¸€ã€‚

***ä»€ä¹ˆæ˜¯å¼‚å¸¸æ£€æµ‹ï¼Ÿ*** åœ¨æ•°æ®åˆ†æä¸­ï¼Œå¼‚å¸¸æ£€æµ‹æ˜¯é€šè¿‡ä¸å¤§å¤šæ•°æ•°æ®æ˜¾è‘—ä¸åŒæ¥è¯†åˆ«å¼•èµ·æ€€ç–‘çš„ç½•è§é¡¹ç›®ã€äº‹ä»¶æˆ–è§‚å¯Ÿå€¼ã€‚å®ƒé€šå¸¸ç”¨äºã€‚

*   æ¬ºè¯ˆæ£€æµ‹
*   ç³»ç»Ÿå¥åº·ç›‘æ§
*   ä¼ æ„Ÿå™¨ç½‘ç»œä¸­çš„äº‹ä»¶æ£€æµ‹
*   ç”Ÿæ€ç³»ç»Ÿå¹²æ‰°
*   æ•°æ®æ¸…ç†
*   å…¥ä¾µæ£€æµ‹

æˆ‘ä»¬å°†é€šè¿‡ä½¿ç”¨å¾®è½¯çš„é¢„æµ‹ç®—æ³•æ¥æ£€æµ‹æ¯”ç‰¹å¸ä»·æ ¼æ—¶é—´åºåˆ—æ•°æ®çš„å¼‚å¸¸ã€‚æ—¶é—´åºåˆ—

***ä»€ä¹ˆæ˜¯æ—¶åºæ•°æ®ï¼Ÿ*** æ—¶é—´åºåˆ—æ•°æ®æ˜¯æŒ‡åœ¨ç‰¹å®šæ—¶é—´èŒƒå›´å†…æ•è·çš„æ•°æ®ï¼Œå¦‚å…¬å¸çš„è‚¡ç¥¨ä»·æ ¼ã€é“¶è¡Œè´¦æˆ·çš„äº¤æ˜“ç­‰ã€‚è¿™äº›æ˜¯æ—¶é—´åºåˆ—æ•°æ®çš„ç»å…¸ä¾‹å­ã€‚
åœ¨æˆ‘ä»¬çš„ç‰¹æ®Šæƒ…å†µä¸‹ï¼Œè¿™å°†æ˜¯è¿‡å» 180 å¤©çš„æ¯”ç‰¹å¸ä»·æ ¼ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨è¿™äº›æ•°æ®æ¥è®­ç»ƒæˆ‘ä»¬çš„æ¨¡å‹ï¼Œä»¥æ£€æµ‹å¼‚å¸¸å¹¶é¢„æµ‹æœªæ¥çš„ä»·æ ¼

![](img/462dd5cbde541bd41d526f344469c881.png)

Bitcoin chart that shows fluctuations in the last 12 months

> [âš ](https://graphemica.com/%E2%9A%A0) è­¦å‘Š:åœ¨ç°å®ç”Ÿæ´»ä¸­ï¼Œæœ‰å¤§é‡çš„å‚æ•°ä¼šå½±å“æ¯”ç‰¹å¸çš„ä»·æ ¼ï¼Œç”¨äººå·¥æ™ºèƒ½æ˜¯ä¸å¯èƒ½å¤„ç†çš„ã€‚æˆ‘ä»¬åªä¼šå‚è€ƒæœ€è¿‘ 6 ä¸ªæœˆçš„ä»·æ ¼ã€‚æˆ‘ä»¬çš„æ¨¡å‹åªä¼šæ ¹æ®æ•°å­—è¯´åŒæ ·çš„è¯ã€‚æ‰€ä»¥ï¼Œæ°¸è¿œä¸è¦æŠŠä½ çš„çœŸé‡‘ç™½é“¶æŠ•å…¥åˆ°ä»»ä½•å£°ç§°æœ‰èƒ½åŠ›åšåˆ°è¿™ä¸€ç‚¹çš„åº”ç”¨ç¨‹åºä¸­

æˆ‘ä»¬åº”è¯¥éµå¾ªè¿™äº›æ­¥éª¤æ¥å¼€å‘åº”ç”¨ç¨‹åºï¼›

ğŸ›ˆ:è®©æˆ‘è¯´ï¼Œä¸‹é¢çš„è¿™äº›æ­¥éª¤ç®€è¦è§£é‡Šäº†æˆ‘ä»¬ä¸ºä»€ä¹ˆè¿™æ ·åšï¼Œä½†æ˜¯å¦‚æœä½ æƒ³è·³è¿‡è¿™ä¸ªéš¾é¢˜å¹¶ä¸‹è½½æºä»£ç ï¼Œè¯·éšæ„é˜…è¯»æ–‡ç« ç»“å°¾ã€‚

1.  é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦æ”¶é›†æ¯”ç‰¹å¸æ•°æ®ï¼Œç”¨äºè®­ç»ƒæˆ‘ä»¬çš„ç½‘ç»œã€‚å‰å¾€[https://coinmarketcap.com](https://coinmarketcap.com/)ç‚¹å‡»æ¯”ç‰¹å¸ï¼Œç„¶åç‚¹å‡»[å†å²æ•°æ®](https://coinmarketcap.com/currencies/bitcoin/historical-data/)é€‰é¡¹å¡ã€‚æ‚¨å°†çœ‹åˆ°ä¸€ä¸ªæ•°æ®ç½‘æ ¼ï¼Œå…¶ä¸­åˆ—å‡ºäº†æ‰€é€‰æ—¥æœŸèŒƒå›´å†…çš„ä»·æ ¼è®°å½•ã€‚å¾ˆé—æ†¾æ²¡æœ‰å¯¼å‡ºä¸ºæ–‡ä»¶é€‰é¡¹ï¼Œä»–ä»¬ä¸è®¤ä¸ºæœ‰äººå¯èƒ½éœ€è¦å®ƒ:)
    æ‰€ä»¥æˆ‘ä»¬éœ€è¦å¤åˆ¶å®ƒã€‚Anway é€‰æ‹©â€œæ—¥æœŸèŒƒå›´â€å’Œâ€œæœ€è¿‘ 180 å¤©â€å¤åˆ¶ç²˜è´´æ•°æ®ï¼ŒåŒ…æ‹¬æ ‡é¢˜(Btw coinmarketcap ä¹Ÿæä¾›å¼€å‘è€… API æ¥å…±äº«èµ„æºï¼Œä½†è¿™æ˜¯é¢˜å¤–è¯)

![](img/7347ea54658da2dfdde3d1a7c26cd093.png)

Our training data source is [https://coinmarketcap.com/currencies/bitcoin/historical-data/](https://coinmarketcap.com/currencies/bitcoin/historical-data/)

2.åˆ›å»ºä¸€ä¸ªç©ºçš„ã€‚Net æ ¸å¿ƒæ§åˆ¶å°åº”ç”¨ç¨‹åºï¼Œå¹¶æ£€æŸ¥`Place solution and project in the same directory``ç„¶åç‚¹å‡»ä¸‹ä¸€æ­¥ï¼Œé€‰æ‹© SDKï¼Œè¿™ä¸ªä¾‹å­ä¸ 3.1 ç‰ˆä¹Ÿå¾ˆå¥½ï¼Œä½†æˆ‘ä¼šå»ã€‚NET 5.0 çš„æœ€æ–°ç‰ˆæœ¬ã€‚ç½‘ç»œæ ¸å¿ƒ

![](img/a008f6280b46329e71825e71c0b01f84.png)

ç„¶ååˆ›å»ºä¸€ä¸ªç©ºçš„ CSV æ–‡ä»¶ï¼Œå¹¶å°† coinmarketcap ä¸­çš„æ•°æ®ç²˜è´´åˆ°å…¶ä¸­ã€‚
ä¸è¦å¿˜è®°æ ¼å¼åŒ–æ—¥æœŸï¼Œè¿™éœ€è¦æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºè¯»å–æ–‡ä»¶ä¸­çš„æ•°æ®

é€‰æ‹©æ—¥æœŸåˆ—å’Œ`Format Cells-> Date -> *3/14/2012`ç„¶åé€‰æ‹©æ‰€æœ‰å…¶ä»–çš„`Format Cells-> Currency -> 1,234.10`ç‚¹å‡»ç¡®å®šç„¶åå†æ¬¡æ ¼å¼åŒ–ç›¸åŒçš„è´§å¸åˆ—`Format Cells-> Currency -> Use 1000 Seperator(,)`ç°åœ¨æˆ‘ä»¬å®Œæˆäº†ã€‚
æ–‡ä»¶å†…å®¹åº”è¯¥æ˜¯è¿™æ ·çš„:

![](img/727b714e3895ec2a8bcba0a3c636ccd7.png)

Dont forget to format data otherwise you gonna encounter an error during loading data to model

![](img/2d300e70b2d93aec91e1b28a069e1d47.png)

ç¿»å›åˆ° VSï¼Œæˆ‘ä»¬éœ€è¦ 2 ä¸ªåº“ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ NuGet åŒ…ç®¡ç†å™¨å®‰è£…å®ƒä»¬ã€‚è¿™äº›æ˜¯**å¾®è½¯ã€‚ML** å’Œ**Microsoft . ML . time series .**æ‚¨çš„é¡¹ç›®è§£å†³æ–¹æ¡ˆåœ¨ä»–çœ‹æ¥åº”è¯¥æ˜¯è¿™æ ·çš„ã€‚

åœ¨ç¬¬ä¸€éƒ¨åˆ†ï¼Œæˆ‘ä»¬å°†æ¶µç›–å¼‚å¸¸æ£€æµ‹ï¼Œç„¶åç»™å®šæ•°æ®çš„ä»·æ ¼é¢„æµ‹ã€‚åœ¨æ­¤ä¹‹å‰ï¼Œæˆ‘ä»¬åº”è¯¥ä»æ–‡ä»¶ä¸­è¯»å–æ•°æ®ï¼Œè®©æˆ‘ä»¬å¼€å§‹ç¼–å†™ä»£ç :åˆ›å»ºä¸€ä¸ª MLContext å®ä¾‹å¹¶åŠ è½½ç›®æ ‡æ–‡ä»¶çš„å†…å®¹ã€‚è¿™æ˜¯æˆ‘ä»¬åº”è¯¥åšçš„ï¼›

```
var context = new MLContext();
var data = context.Data.LoadFromTextFile<CurrencyModel>(targetFile, hasHeader: true, separatorChar: â€˜,â€™);
```

æ¥ä¸‹æ¥ï¼Œåˆ›å»ºä¸€ä¸ªä¼°è®¡å™¨æ¥æ£€æµ‹å¼‚å¸¸ï¼Œæˆ‘ä»¬å°†åœ¨ ML ä¸Šä¸‹æ–‡çš„å˜æ¢ç›®å½•ä¸­ä½¿ç”¨å¥‡å¼‚è°±åˆ†æï¼Œå¹¶å˜æ¢æƒ³è¦å½¢æˆçš„æ•°æ®:

```
var pipelineAnomaly = context.Transforms.DetectSpikeBySsa(nameof(SpikeAnomaly.Anomalies),nameof(CurrencyModel.Close), confidence: 98.0,trainingWindowSize: 90, seasonalityWindowSize: 30, pvalueHistoryLength: 20);
var transformedData = pipelineAnomaly.Fit(data).Transform(data);
```

ğŸ›ˆ:æˆ‘å‘ç°æ¯”ç‰¹å¸çš„â€œ*æ”¶ç›˜*ä»·æ ¼å‡ºç°å¼‚å¸¸ï¼Œè¿™è¡¨æ˜è¿™æ˜¯å½“å¤©çš„æœ€ç»ˆä»·æ ¼ã€‚å¦‚æœæ‚¨æƒ³æ£€æµ‹*æœ€é«˜*æˆ–*æœ€ä½*ä»·æ ¼ï¼Œåªéœ€æ ¹æ®éœ€è¦æ›´æ”¹æ­¤åˆ—ï¼Œå®ƒå¿…é¡»ä¸ç›®æ ‡æ•°æ®åˆ—åç§°ç›¸åŒã€‚

æœ€åï¼Œåˆ›å»ºä¸€ä¸ªåˆ—è¡¨æ¥å­˜å‚¨æ£€æµ‹åˆ°çš„å¼‚å¸¸:

```
var anomalies = context.Data.CreateEnumerable<SpikeAnomaly>(transformedData, reuseRowObject: false).ToList();
```

ç„¶åå‘æ§åˆ¶å°å†™å…¥æ£€æµ‹åˆ°çš„å¼‚å¸¸ç»™å®šæ•°æ®:

```
var prices = data.GetColumn<float>("Close").ToArray();
var dates = data.GetColumn<DateTime>("Date").ToArray();
for (int i = 0; i < anomalies.Count; i++) {
   if (anomalies[i].Anomalies[0] == 1) {
      Console.WriteLine($"{dates[i]}\t{prices[i]}");
   }
}
```

å°±è¿™æ ·ï¼Œç°åœ¨è¿è¡Œåº”ç”¨ç¨‹åºï¼Œçœ‹çœ‹å®ƒæ˜¯å¦åƒé¢„æœŸçš„é‚£æ ·å·¥ä½œï¼Œä½ åº”è¯¥ä¼šçœ‹åˆ°ä¸€ä¸ªç±»ä¼¼è¿™æ ·çš„çª—å£ï¼›

![](img/8069efc3517df8f1f683a5cc3b6ce6a3.png)

å¼‚å¸¸æ£€æµ‹åˆ°æ­¤ç»“æŸï¼Œç°åœ¨è®©æˆ‘ä»¬å¼€å§‹ç¬¬äºŒéƒ¨åˆ†
ä»·æ ¼é¢„æµ‹:
æˆ‘ä»¬å·²ç»å°†æ•°æ®åŠ è½½åˆ° ML ä¸Šä¸‹æ–‡ä¸­ï¼Œå› æ­¤æˆ‘ä»¬åªéœ€è¦é€šè¿‡é¢„æµ‹å¥‡å¼‚è°±åˆ†æ(SSA)å‡½æ•°åˆ›å»ºä¸€ä¸ªæ–°çš„ä¼°è®¡å™¨å¹¶åˆ›å»ºä¸€ä¸ªæ¨¡å‹ï¼›

```
var pipelinePrediction = context.Forecasting.ForecastBySsa(nameof(PricePrediction.Predictions), nameof(CurrencyModel.Close), windowSize: 5, seriesLength: 10, trainSize: 100, horizon: 2); 
var model = pipelinePrediction.Fit(data);
```

ç„¶åä¸ºæ—¶åºç®¡é“åˆ›å»ºé¢„æµ‹å¼•æ“ï¼Œå¹¶è°ƒç”¨é¢„æµ‹å‡½æ•°ã€‚æ‚¨è¿˜å¯ä»¥å®šä¹‰å°†è¦è®¡ç®—çš„é¢„æµ‹æ•°ã€‚åœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­ï¼Œå®ƒå°†æ˜¯ 3ï¼Œå› æ­¤æœªæ¥ 3 å¤©çš„æ¯”ç‰¹å¸ä»·æ ¼å°†é€šè¿‡ä½¿ç”¨é¢„æµ‹å¼•æ“æ¥é¢„æµ‹ã€‚

```
var forecastContext = model.CreateTimeSeriesEngine<CurrencyModel, PricePrediction>(context); 
var forecasts = forecastContext.Predict(3); // Predict prices in next 3 days
foreach (var item in forecasts.Predictions) {       Console.WriteLine(item); 
}
```

`Predict`åŠŸèƒ½ä¸­çš„å‚æ•°è¡¨ç¤ºé¢„æµ‹çš„æ•°é‡å°†ç”±å¼•æ“è®¡ç®—ã€‚åœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬å¸Œæœ›çœ‹åˆ°æ¥ä¸‹æ¥çš„ 3 å¤©ã€‚å®Œæˆæ­¤æ­¥éª¤åï¼Œæ‚¨çš„ä»£ç è§£å†³æ–¹æ¡ˆæ–‡ä»¶åº”è¯¥å¦‚ä¸‹æ‰€ç¤º:

![](img/b3e35627e62a1d1cb3790d7c02388124.png)

è®©æˆ‘ä»¬è¿è¡Œè¿™ä¸ªé¡¹ç›®ï¼Œçœ‹çœ‹å®ƒæ˜¯å¦‚ä½•å·¥ä½œçš„ã€‚

![](img/5d8c34344e24a023616952016bc4c5fd.png)

å¦‚æœä½ åœ¨ä½ çš„æ§åˆ¶å°ä¸Šçœ‹åˆ°è¿™æ ·çš„ä¸œè¥¿ï¼Œé‚£å°±æ˜¯äº†ã€‚æˆ‘ä»¬å¯¹åŒ…å«æ¯”ç‰¹å¸ä»·æ ¼çš„ç»™å®šæ–‡ä»¶(data.csv)çš„å¼‚å¸¸æ£€æµ‹å’Œé¢„æµ‹éå¸¸æœ‰æ•ˆğŸ¤˜

è¿™å°±æ˜¯æˆ‘åœ¨è¿™ç¯‡æ–‡ç« é‡Œæƒ³åˆ†äº«çš„å…¨éƒ¨ã€‚ä½ å¯ä»¥åœ¨è¿™é‡Œä¸‹è½½å®Œæ•´çš„[æºä»£ç ï¼Œè‡ªå·±è¿è¡Œæˆ–è€…æ”¹è¿›é¡¹ç›®ã€‚å¦‚æœæ‚¨æœ‰ä»»ä½•é—®é¢˜ï¼Œè¯·åœ¨ä¸‹é¢çš„éƒ¨åˆ†ç•™è¨€ã€‚ç¥å¤§å®¶å¿«ä¹å¥åº·ï¼](https://github.com/y3n3rrr/AnomalyDetectionSample)

å†ä¼šï¼Œ
ä¹°ä¹°æÂ·è€¶çº³å°”Â·è€¶å°”é©¬å…¹