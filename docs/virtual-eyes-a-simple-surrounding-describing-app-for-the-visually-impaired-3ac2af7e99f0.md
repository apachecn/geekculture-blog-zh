# è™šæ‹Ÿçœ¼ç›â€”â€”ä¸ºè§†éšœäººå£«è®¾è®¡çš„ç®€å•ç¯å¢ƒæè¿°åº”ç”¨ç¨‹åº

> åŸæ–‡ï¼š<https://medium.com/geekculture/virtual-eyes-a-simple-surrounding-describing-app-for-the-visually-impaired-3ac2af7e99f0?source=collection_archive---------43----------------------->

![](img/7584a0a34dd60781be528c9a6ebcfd23.png)

åœ¨è¿‡å»çš„å‡ å¹´é‡Œï¼Œå›¾åƒå­—å¹•å¯¹æœºå™¨å­¦ä¹ é¢†åŸŸäº§ç”Ÿäº†å·¨å¤§çš„å½±å“ï¼Œæ–°çš„åº”ç”¨æ¯å¤©éƒ½åœ¨å‡ºç°ã€‚å›¾åƒå­—å¹•æ˜¯ä½¿ç”¨äººå·¥æ™ºèƒ½ã€è®¡ç®—æœºè§†è§‰å’Œæœºå™¨å­¦ä¹ æ¥ç”Ÿæˆå›¾åƒæè¿°çš„èƒ½åŠ›ï¼Œç±»ä¼¼äºäººç±»æè¿°å›¾åƒå†…å®¹çš„æ–¹å¼ã€‚åœ¨è¿™ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘å°†è®¨è®ºæˆ‘å¦‚ä½•åˆ›å»ºä¸€ä¸ªç®€å•çš„åº”ç”¨ç¨‹åºï¼Œä½¿ç”¨å›¾åƒå­—å¹•å‘è§†éšœäººå£«æè¿°å‘¨å›´çš„ç¯å¢ƒã€‚

ä¸ºäº†æä¾›è¿™æ¬¾åº”ç”¨çš„æ¦‚è¿°ï¼Œå½“ç”¨æˆ·å‘å‡ºè¯­éŸ³å‘½ä»¤æ—¶ï¼Œå®ƒä½¿ç”¨æ‰‹æœºçš„ä¸»æ‘„åƒå¤´æ¥æ•æ‰ç…§ç‰‡ï¼Œå¹¶ä½¿ç”¨ Azure è®¡ç®—æœºè§†è§‰æœåŠ¡ï¼Œè¯¥åº”ç”¨ç”Ÿæˆå­—å¹•ä»¥åŠå¯¹è±¡çš„ä½ç½®æ•°æ®ï¼Œå¹¶ä»¥è‡ªç„¶è¯­è¨€ä¸ç”¨æˆ·äº¤è°ˆã€‚

å¦‚æœæ‚¨æ¸´æœ›è§‚çœ‹è¯¥åº”ç”¨ç¨‹åºçš„æ¼”ç¤ºï¼Œè¯·é˜…è¯»æœ¬æ–‡æœ«å°¾ã€‚

## **å¼€å‘å®‰å“åº”ç”¨**

ä¸ºäº†å¼€å‘è¿™ä¸ªåº”ç”¨ç¨‹åºï¼Œæˆ‘ä½¿ç”¨äº† Unity å’Œ Azure è®¡ç®—æœºè§†è§‰æœåŠ¡ã€‚æ‰€ä»¥ï¼Œè®©æˆ‘ä»¬æ¥çœ‹çœ‹æ˜¯æ€ä¹ˆåšåˆ°çš„ã€‚

1.  åˆ›å»º Azure è®¡ç®—æœºè§†è§‰èµ„æºã€‚

æˆ‘å†™äº†ä¸€æ•´ç¯‡å…³äºå¦‚ä½•åˆ›å»º Azure è®¡ç®—æœºè§†è§‰èµ„æºå¹¶åœ¨ Unity [ä¸­ä½¿ç”¨å…¶æœåŠ¡çš„æ–‡ç« ã€‚ä½ å¯ä»¥å‚è€ƒå®ƒæ¥äº†è§£æ›´å¤šå…³äºè®¾ç½® Azure çš„çŸ¥è¯†ï¼Œå› ä¸ºæˆ‘ä¸ä¼šè¯¦ç»†è®¨è®ºè¿™ä¸ªã€‚](/codex/image-captioning-in-unity-android-using-azure-computer-vision-c9424f9d1ab1)

2.åˆ›å»º Unity Android åº”ç”¨ç¨‹åº

æˆ‘é¦–å…ˆåˆ›å»ºäº†ä¸€ä¸ªç»Ÿä¸€ 2D é¡¹ç›®ï¼Œæˆ‘å¿…é¡»æ”¹å˜ä¸€äº›é…ç½®ï¼Œä»¥é€‚åº”è¿™ä¸ªé¡¹ç›®ï¼Œå¦‚ä¸‹æ‰€ç¤º:

**1ã€‚æ¢å¹³å°å®‰å“**

(æ–‡ä»¶->æ„å»ºè®¾ç½®-> Android ->åˆ‡æ¢å¹³å°)

**2ã€‚å¯¼å…¥ Newtonsoft DLL æ–‡ä»¶å¹¶åœ¨ Assets ä¸­è®¾ç½® csc.rsp æ–‡ä»¶ã€‚**

**3ã€‚æ›´æ”¹ API å…¼å®¹çº§åˆ«**

'ç¼–è¾‘->é¡¹ç›®è®¾ç½®->æ’­æ”¾å™¨->å…¶ä»–è®¾ç½®-> API å…¼å®¹çº§åˆ«ä»'ã€‚NET Standard 2.0 'åˆ°'ã€‚NET 4.x '

åœ¨æˆ‘å…³äºä½¿ç”¨ Azure è®¡ç®—æœºè§†è§‰çš„ Unity Android ä¸­çš„[å›¾åƒå­—å¹•çš„æ–‡ç« ](/codex/image-captioning-in-unity-android-using-azure-computer-vision-c9424f9d1ab1)ä¸­ï¼Œå·²ç»è§£é‡Šäº†ä¸Šè¿°æ‰€æœ‰ä»»åŠ¡(å¹¶ç»™å‡ºäº†åŸå› )ã€‚

**4ã€‚è®¾ç½®æ–‡æœ¬åˆ°è¯­éŸ³å’Œè¯­éŸ³åˆ°æ–‡æœ¬**

ä¸ºäº†æ‰§è¡Œè¿™ä¸ªä»»åŠ¡ï¼Œæˆ‘åœ¨ä»–çš„ [Github åº“](https://github.com/j1mmyto9/Speech-And-Text-Unity-iOS-Android)ä¸Šä½¿ç”¨äº† [j1mmyto9](https://github.com/j1mmyto9) æä¾›çš„æ’ä»¶ã€‚è¿™ä¸ª[æ•™ç¨‹](https://www.youtube.com/watch?v=XRXbVtr1fog)è§£é‡Šäº†å¦‚ä½•åœ¨ä½ çš„ unity é¡¹ç›®ä¸­ä½¿ç”¨ä¸Šè¿°æ’ä»¶ã€‚

æˆ‘æ˜¯è¿™æ ·åšçš„:

1.  ä¸‹è½½ Github åº“å¹¶è§£å‹æ–‡ä»¶ã€‚
2.  æ‰“å¼€â€œSpeechToText_AppleAPI/Assets/â€æ–‡ä»¶å¤¹ï¼Œå°†â€œPluginsâ€å’Œâ€œSpeechAndTextâ€æ–‡ä»¶å¤¹å¤åˆ¶åˆ° Unity é¡¹ç›®çš„ Assets æ–‡ä»¶å¤¹ä¸­ã€‚
3.  åˆ›å»ºä¸¤ä¸ªåä¸ºâ€œSpeechToTextâ€å’Œâ€œTextToSpeechâ€çš„ç©ºæ¸¸æˆå¯¹è±¡ï¼Œå¹¶å°†åä¸ºâ€œSpeechToText.csâ€å’Œâ€œTextToSpeech.csâ€çš„ C#è„šæœ¬åˆ†åˆ«ä½œä¸ºç»„ä»¶æ·»åŠ åˆ°ä¸Šè¿°æ¸¸æˆå¯¹è±¡ä¸­ã€‚

***æ³¨*** *:ä¸Šé¢æåˆ°çš„è¿™äº›åå­—ï¼Œè¦å®Œå…¨æŒ‰ç…§è§„å®šã€‚*

å¦å¤–ï¼Œåœ¨æ£€æŸ¥å™¨ä¸­å–æ¶ˆé€‰ä¸­ SpeechToText è„šæœ¬çš„â€œIsShowPopupAndroidâ€é€‰é¡¹ã€‚

å®ƒçœ‹èµ·æ¥æ˜¯è¿™æ ·çš„:

![](img/4a233b1e521535ae404d2e463555919d.png)

4.åˆ›å»ºä¸€ä¸ªç©ºçš„æ¸¸æˆå¯¹è±¡ï¼Œå¹¶å°†å…¶å‘½åä¸ºâ€œSpeechHandlerâ€(è¿™ä¸ªåç§°å¯ä»¥ä¸åŒ)ã€‚

5.åˆ›å»ºä¸€ä¸ªåä¸ºâ€œSpeechHandler.csâ€çš„ C#è„šæœ¬ï¼Œå¹¶å°†å…¶ä½œä¸ºç»„ä»¶æ·»åŠ åˆ°ä¸Šé¢åˆ›å»ºçš„â€œSpeechHandlerâ€æ¸¸æˆå¯¹è±¡ä¸­ã€‚è¿™ä¸ªè„šæœ¬å°†åŒ…å«å¤„ç†è¯­éŸ³ç›¸å…³åŠŸèƒ½çš„ä»£ç ã€‚

5.åˆ›å»ºä¸€ä¸ª C#è„šæœ¬æ¥ç®¡ç†å‡½æ•°

åˆ›å»ºä¸€ä¸ªåä¸ºâ€œcaption.csâ€çš„ C#è„šæœ¬æ¥ç®¡ç†æ‰€æœ‰å…¶ä»–å‡½æ•°ï¼ŒåŒ…æ‹¬ API è°ƒç”¨ã€‚æ¥ä¸‹æ¥ï¼Œåˆ›å»ºä¸€ä¸ªåä¸ºâ€œcaptionHandlerâ€çš„ç©ºæ¸¸æˆå¯¹è±¡ï¼Œå¹¶å°†â€œcaption.csâ€è„šæœ¬æ·»åŠ åˆ°ä¸Šé¢çš„æ¸¸æˆå¯¹è±¡ä¸­ã€‚

**5ã€‚åœ¨ Unity ä¸­åˆ›å»º UI ç»„ä»¶**

åˆ›å»ºä¸€ä¸ªé¢æ¿ï¼Œåœ¨é¢æ¿ä¸‹åˆ›å»ºä¸€ä¸ª RawImage(è®¾ç½® z æ—‹è½¬ä¸º-90)å’Œä¸€ä¸ª Text gameobject ä½œä¸ºé¢æ¿çš„å­é¢æ¿ï¼Œåˆ†åˆ«å‘½åä¸ºâ€œCameraFeedâ€å’Œâ€œSpeechStatusâ€ã€‚å¯¹äº†ï¼Œæˆ‘ä»æ¸¸æˆçª—å£æŠŠé•¿å®½æ¯”æ”¹æˆäº† 2160x1080 äººåƒã€‚æ‚¨å¯èƒ½è¿˜æƒ³è°ƒæ•´ UI å…ƒç´ çš„å¤§å°ã€‚

ä»¥ä¸‹æ˜¯æˆ‘çš„è®¾ç½®:

![](img/21a62ff32d8a2c6904005c5112ad7654.png)

ç°åœ¨ï¼Œè®¾ç½®è¿‡ç¨‹å·²ç»å®Œæˆã€‚æ¥ä¸‹æ¥æ˜¯ç¼–ç ä»»åŠ¡ã€‚

é¦–å…ˆï¼Œæˆ‘å°†è®¨è®ºâ€œcaption.csâ€è„šæœ¬ã€‚

**caption.cs**

è¯¥è„šæœ¬åŒ…å«ä»¥ä¸‹æˆå‘˜å˜é‡:

```
// Add your Computer Vision subscription key and endpoint
static string subscriptionKey = "PASTE_YOUR_COMPUTER_VISION_SUBSCRIPTION_KEY_HERE";//azure endpoint
static string endpoint = "PASTE_YOUR_COMPUTER_VISION_ENDPOINT_HERE";//azure endpoint service accessed
static string captionBase = "vision/v3.2/describe?"; //endpoint to generate image captionsstatic string objectBase = "vision/v3.2/analyze?"; //endpoint to get object locations//UI Components
[SerializeField] private RawImage cameraFeed;//webcamtexture
private WebCamTexture webcamTexture;
```

ä¸Šè¿°å˜é‡ç”¨äº Azure è®¢é˜…å¯†é’¥ã€Azure API ç«¯ç‚¹ã€å°†é™„åŠ åˆ°ç«¯ç‚¹çš„ captionBase å’Œ objectBaseã€RawImage UI ç»„ä»¶å’Œ webcamtextureã€‚

æ ‡é¢˜åº“å’Œå¯¹è±¡åº“æ˜¯æˆ‘å‘ azure è¯·æ±‚çš„åŠŸèƒ½ã€‚â€œæè¿°â€ç‰¹å¾åŒ…æ‹¬å›¾åƒæ ‡é¢˜ï¼Œè€Œâ€œåˆ†æâ€ç‰¹å¾åŒ…æ‹¬æ£€æµ‹åˆ°çš„ç‰©ä½“ç›¸å¯¹äºå›¾åƒçš„ä½ç½®ã€‚

åœ¨è¿™ä¸ªé¡¹ç›®ä¸­ï¼Œæˆ‘é€‰æ‹©äº†å•ä¸€è®¾è®¡æ¨¡å¼ï¼Œå› æ­¤æˆ‘åˆ›å»ºäº†ä¸€ä¸ªç±»æœ¬èº«çš„å®ä¾‹ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚

```
//instance of caption class
private static caption instance;public static caption Instance
{
 get
 {
  if (instance == null)
   {
    instance = FindObjectOfType<caption>();
   }
  return instance;
 }
}
```

æ¥ä¸‹æ¥ï¼Œéœ€è¦åœ¨åº”ç”¨ç¨‹åºå¯åŠ¨æ—¶æ£€æŸ¥ç”¨æˆ·æƒé™ã€‚è¿™å¯ä»¥é€šè¿‡ä¸‹é¢çš„æ–¹æ³•æ¥å®Œæˆã€‚

```
void CheckPermissin()
{
 if (!Permission.HasUserAuthorizedPermission(Permission.Camera))
 {
  Permission.RequestUserPermission(Permission.Camera);
 }
 if (!Permission.HasUserAuthorizedPermission(Permission.Microphone))
 {
  Permission.RequestUserPermission(Permission.Microphone);
 }
 if(Permission.HasUserAuthorizedPermission(Permission.Camera) && Permission.HasUserAuthorizedPermission(Permission.Microphone))
 {
  //start camera feed if both permissions granted
  startCamera();
  }
}
```

æ­¤æ–¹æ³•æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æˆäºˆäº†éº¦å…‹é£å’Œæ‘„åƒæœºæƒé™ï¼Œå¦‚æœæ²¡æœ‰ï¼Œåˆ™è¦æ±‚ç”¨æˆ·æˆäºˆæƒé™ã€‚å¦‚æœä¸¤ç§æƒé™éƒ½è¢«æˆäºˆï¼Œè¯¥æ–¹æ³•å°†è°ƒç”¨â€œstartCameraâ€æ–¹æ³•ï¼Œè¯¥æ–¹æ³•å¯åŠ¨æ‘„åƒæœºå¹¶å°†æ‘„åƒæœºæºåˆ†é…ç»™â€œcamera feedâ€raw imageã€‚æ˜¾ç„¶ï¼Œè¿™å¯¹è§†åŠ›å—æŸçš„äººæ¥è¯´æ²¡æœ‰ç”¨ï¼Œä½†æ˜¯ä¸ºäº†æˆ‘ä»¬çš„æ–¹ä¾¿ï¼Œæˆ‘å·²ç»å®ç°äº†è¿™ä¸€ç‚¹ã€‚

```
void startCamera()
{
 //get all camera devices 
 WebCamDevice[] cam_devices = WebCamTexture.devices; //Set a camera to the webcamTexture
 webcamTexture = new WebCamTexture(cam_devices[0].name, 480, 640, 30); //Set the webcamTexture to the texture of the rawimage
 cameraFeed.texture = webcamTexture;
 cameraFeed.material.mainTexture = webcamTexture; //Start the camera
 webcamTexture.Play();
}
```

æ¥ä¸‹æ¥å‡ºç°çš„é—®é¢˜æ˜¯æˆ‘åº”è¯¥åœ¨å“ªé‡Œè°ƒç”¨â€œCheckPermissionâ€æ–¹æ³•ã€‚ç”±äºæƒé™æ£€æŸ¥æ˜¯å¼‚æ­¥å®Œæˆçš„ï¼Œåº”ç”¨ç¨‹åºæ— éœ€ç­‰å¾…ç”¨æˆ·æƒé™å°±å¼€å§‹è¿è¡Œï¼Œä»è€Œå¯¼è‡´â€œç›¸æœºé¦ˆé€â€åŸå§‹å›¾åƒä¸Šå‡ºç°ç™½å±ï¼Œè€Œä¸æ˜¯æ¸²æŸ“ç›¸æœºé¦ˆé€ã€‚å› æ­¤ï¼Œåœ¨â€œstartâ€æ–¹æ³•ä¸­è°ƒç”¨æ­¤æ–¹æ³•ä¼šå¯¼è‡´æ­¤ç±»é”™è¯¯ã€‚å› æ­¤ï¼Œæˆ‘åœ¨â€œOnApplicationFocusâ€å›è°ƒä¸­è¾“å…¥äº†å¯¹â€œCheckPermissionâ€æ–¹æ³•çš„è°ƒç”¨ï¼Œè¯¥å›è°ƒåœ¨åº”ç”¨ç¨‹åºæ¯æ¬¡è¿”å›ç„¦ç‚¹æ—¶è¿è¡Œï¼Œå› æ­¤å®ƒå°†é‡å¤æ£€æŸ¥æ‰€æœ‰æƒé™ï¼Œç›´åˆ°æ‰€æœ‰æƒé™éƒ½è¢«æˆäºˆã€‚ä¸‹é¢ç»™å‡ºäº†å®ç°è¿™ä¸€ç‚¹çš„ä»£ç ã€‚

```
private void OnApplicationFocus(bool focus)
{
 //check for permission
 CheckPermissin();
}
```

æ¥ä¸‹æ¥ï¼Œæˆ‘åˆ›å»ºäº†ä¸€ä¸ªåä¸ºâ€˜save imageâ€™çš„ IEnumerator æ–¹æ³•ï¼Œä»æ‘„åƒæœºè¾“å…¥ä¸­æ•è·å›¾åƒï¼Œå¹¶å°†å›¾åƒå­—èŠ‚æ•°æ®ä¼ é€’ç»™å¦ä¸€ä¸ªå¤„ç† API è°ƒç”¨çš„æ–¹æ³•ã€‚æ­¤æ–¹æ³•æ˜¯ IEnumeratorï¼Œå› ä¸ºå®ƒä½¿ç”¨â€œyield returnâ€æ¥ç­‰å¾…å½“å‰å¸§çš„ç»“æŸã€‚æ­¤å¤–ï¼Œæ‚¨ä¼šæ³¨æ„åˆ°å¯¹â€œRotateTextureâ€æ–¹æ³•çš„è°ƒç”¨ï¼Œè¯¥æ–¹æ³•ç”¨äºå°† Texture2D æ—‹è½¬ç»™å®šçš„è§’åº¦ã€‚è¿™ä¸ªæ–¹æ³•å¯ä»¥ä»[è¿™é‡Œ](https://www.programmersought.com/article/69288818191/)å¾—åˆ°ã€‚

SaveImage()æ–¹æ³•è¿˜æ¥å—ä¸€ä¸ªå¸ƒå°”å‚æ•°â€œisDescribe â€,å¦‚æœç”¨æˆ·éœ€è¦å›¾åƒæ ‡é¢˜ï¼Œè¯¥å‚æ•°ä¸º true å¦‚æœç”¨æˆ·éœ€è¦ä½ç½®æ•°æ®ï¼Œè¯¥å‚æ•°ä¸º falseã€‚

ä¸‹é¢ç»™å‡ºçš„æ˜¯è¿™ç§æ–¹æ³•:

```
public IEnumerator SaveImage(bool isDescribe)
{
 //Create a Texture2D with the size of the rendered image on the screen.
 Texture2D texture = new Texture2D(webcamTexture.width, webcamTexture.height, TextureFormat.ARGB32, false); //wait till end of frame
 yield return new WaitForEndOfFrame(); //save webcam frame to texture
 texture.SetPixels(webcamTexture.GetPixels()); //rotate texture
 texture = RotateTexture(texture, -90);
 texture.Apply(); //check user requirement whether caption or object position 
 if (isDescribe)
 {
  getCaption(texture.EncodeToPNG());
 }
 else
 {
  getObjects(texture.EncodeToPNG());
 }
}
```

æ¥ä¸‹æ¥ï¼Œæˆ‘å°†è®¨è®ºä»â€œSaveImageâ€æ–¹æ³•è°ƒç”¨çš„â€œgetCaptionâ€å’Œâ€œgetObjectsâ€æ–¹æ³•ã€‚

â€œgetCaptionâ€æ–¹æ³•åŒ…å«åˆ›å»ºæœ€ç»ˆ uriBase çš„ä»£ç ä»¥åŠå¿…è¦çš„è¯·æ±‚å‚æ•°ã€‚ç„¶åï¼Œè¯¥æ–¹æ³•å°†è¿™äº›æ•°æ®ä¸å›¾åƒå­—èŠ‚æ•°ç»„ä¸€èµ·ä¼ é€’ç»™â€œMakeRequestâ€æ–¹æ³•ï¼Œè¯¥æ–¹æ³•è°ƒç”¨ API å¹¶è¿”å›æ•°æ®ã€‚æ¥ä¸‹æ¥ï¼Œéœ€è¦å¤„ç†è¿”å›çš„æ•°æ®ä»¥æå–æ ‡é¢˜ï¼Œè¿™æ˜¯é€šè¿‡è°ƒç”¨â€œconvertCaptionâ€æ–¹æ³•å®Œæˆçš„ï¼Œç„¶åä¼ é€’ç»™ SpeechHandler(å¾ˆå¿«å°±ä¼šå®ç°)ä»¥æœ—è¯»æ ‡é¢˜ã€‚

```
public async void getCaption(byte[] imageBytes)
{
 //uri
 string uriBase = endpoint + captionBase; // Request parameters
 var requestParameters = HttpUtility.ParseQueryString(string.Empty);
 requestParameters["maxCandidates"] = "1";
 requestParameters["language"] = "en";
 requestParameters["model-version"] = "latest"; // call makeRequest method to make API call
 String result = await MakeRequest(uriBase, requestParameters, imageBytes); //extract caption
 string convResult = convertCaption(result); //speak caption
 SpeechHandler.Instance.StartSpeaking(convResult);
}
```

ä¸ä¸Šé¢çš„â€œgetCaptionsâ€æ–¹æ³•ç±»ä¼¼çš„æ˜¯â€œgetObjectsâ€æ–¹æ³•ï¼Œå®ƒæœ‰è‡ªå·±çš„ uriBase å’Œ request å‚æ•°ï¼Œä»¥åŠå¯¹â€œMakeRequestâ€æ–¹æ³•å’Œâ€œconvertObjectsâ€æ–¹æ³•çš„è°ƒç”¨ï¼Œåè€…æå–ä½ç½®æ•°æ®å¹¶åˆ›å»ºä¸€ä¸ªå¥å­å¹¶å°†å…¶è¿”å›ï¼Œæœ€åè°ƒç”¨ SpeechHandler è¯´å‡ºå¸¦æœ‰ä½ç½®æ•°æ®çš„å¥å­ã€‚

```
public async void getObjects(byte[] imageBytes)
{
 // uri
 string uriBase = endpoint + objectBase; // Request parameters
 var requestParameters = HttpUtility.ParseQueryString(string.Empty);
 requestParameters["visualFeatures"] = "Objects";
 requestParameters["language"] = "en";
 requestParameters["model-version"] = "latest"; // call makeRequest method to make API call
 String result = await MakeRequest(uriBase, requestParameters, imageBytes); //extract position sentence
 string convResult = convertObjects(result); //speak
 SpeechHandler.Instance.StartSpeaking(convResult);
}
```

æ¥ä¸‹æ¥æ˜¯â€œMakeRequestâ€æ–¹æ³•ï¼Œå®ƒåŒ…æ‹¬å¯¹ Azure API çš„è°ƒç”¨ï¼Œå¹¶è¿”å›ç”Ÿæˆçš„å“åº”ã€‚è¦äº†è§£æ›´å¤šå…³äºè¿™ç§æ–¹æ³•çš„ä¿¡æ¯ï¼Œè¯·è®¿é—®[è¿™é‡Œ](/codex/image-captioning-in-unity-android-using-azure-computer-vision-c9424f9d1ab1)ã€‚ä¸‹é¢æ˜¯â€œMakeRequestâ€æ–¹æ³•:

```
async Task<String> MakeRequest(string uriBase, NameValueCollection requestParameters, byte[] byteData)
{
 //initialize variable for result
 String responseText = "";
 try
 {
  HttpClient client = new HttpClient(); // Request headers
  client.DefaultRequestHeaders.Add("Ocp-Apim-Subscription-Key", subscriptionKey); // Assemble the URI for the REST API method.
  string uri = uriBase + requestParameters; HttpResponseMessage response; // Request body
  using (var content = new ByteArrayContent(byteData))
  {
   content.Headers.ContentType = new MediaTypeHeaderValue("application/octet-stream"); // Asynchronously call the REST API method.
   response = await client.PostAsync(uri, content); // Asynchronously get the JSON response.
   responseText = await response.Content.ReadAsStringAsync();
  }
 }
 catch
 {
  responseText = "";
 }
 return responseText;
}
```

ç°åœ¨ï¼Œè®©æˆ‘ä»¬è®¨è®ºä¸€ä¸‹æˆ‘ä»¬ä¹‹å‰è°ƒç”¨çš„â€œconvertCaptionâ€å’Œâ€œconvertObjectsâ€æ–¹æ³•ã€‚

â€œconvertCaptionâ€æ–¹æ³•åŸºæœ¬ä¸Šä» API æ¥æ”¶å“åº”å­—ç¬¦ä¸²ï¼Œå°†å…¶è½¬æ¢ä¸º JSON å¯¹è±¡ï¼Œå¹¶æå–å…¶ä¸­åŒ…å«æ ‡é¢˜çš„å¦ä¸€ä¸ª JSON å¯¹è±¡ã€‚è¿™ä¸ªæ ‡é¢˜å¯¹è±¡åŒ…å«ä¸€ä¸ªæ ‡é¢˜æ•°ç»„ï¼Œå› æ­¤é¦–å…ˆéœ€è¦å°†å®ƒè§£ææˆä¸€ä¸ª JArrayï¼Œç„¶åæå–ç¬¬ä¸€ä¸ªæ ‡é¢˜ã€‚è¿™æ˜¯å¦‚ä½•åšåˆ°çš„:

```
public string convertCaption(string responseText)
{
 //initialize variable for caption
 string textCaption = "";

 try
 {
  //convert result to a dictionary
  var jsonResult = JsonConvert.DeserializeObject<Dictionary<string, dynamic>>(responseText); //obtain captions object from jsonResult
  var captionsObj = jsonResult["description"]["captions"]; //convert captionsObj to JArray
  JArray captionArray = JArray.Parse(captionsObj.ToString()); //get caption string from array
  textCaption = captionArray[0]["text"].ToString();
 }
 catch
 {
  textCaption = "Couldn't get description, Please try again !";
 }
 return textCaption;
}
```

â€œconvertObjectsâ€æ–¹æ³•è¿˜ä» API è·å–å“åº”å­—ç¬¦ä¸²ï¼Œé€šè¿‡ååºåˆ—åŒ–å°†å…¶è½¬æ¢ä¸ºå¯¹è±¡ï¼Œå¹¶æå–å…¶ä¸­çš„â€œobjectsâ€JSON å¯¹è±¡ã€‚ç„¶åå°†è¯¥å¯¹è±¡è½¬æ¢ä¸º JArrayï¼Œä»¥è®¿é—®å›¾åƒä¸­æ¯ä¸ªæ£€æµ‹åˆ°çš„å¯¹è±¡çš„ä½ç½®å’Œå¤§å°ã€‚è¯¥æ–¹æ³•è¿˜åŒ…æ‹¬å¯¹â€œä½ç½®â€æ–¹æ³•çš„è°ƒç”¨ï¼Œè¯¥æ–¹æ³•è®¡ç®—å¯¹è±¡æ˜¯åœ¨å›¾åƒçš„å·¦è¾¹ã€å³è¾¹è¿˜æ˜¯ä¸­é—´éƒ¨åˆ†ã€‚ä½¿ç”¨æ­¤ä¿¡æ¯ï¼Œåˆ›å»ºäº†åä¸ºå·¦ã€å³å’Œå‰çš„ 3 ä¸ªåˆ—è¡¨ï¼Œå¹¶å°†ç›¸å…³å¯¹è±¡é™„åŠ åˆ°åˆ—è¡¨ä¸­ã€‚

æœ€åï¼Œä¸ºåº”ç”¨ç¨‹åºåˆ›å»ºä¸€ä¸ªå¥å­ï¼Œè¯´å‡ºå¯¹è±¡çš„ä½ç½®ã€‚

è¿™æ˜¯å¦‚ä½•åšåˆ°çš„:

```
public string convertObjects(string responseText)
{
 //initialize string to store final sentence
 string objectsText = ""; try
 {
  //convert result to dictionary
  var jsonResult = JsonConvert.DeserializeObject<Dictionary<string, dynamic>>(responseText); //obtain objects
  var objects = jsonResult["objects"]; //obtain width of image
  var width = jsonResult["metadata"]["width"]; //convert width to double
  double imageWidth = double.Parse(width.ToString()); //convert objects to JArray
  JArray objsArray = JArray.Parse(objects.ToString()); //initialize 3 lists to store objects in left, front, right
  List<string> left = new List<string>();
  List<string> front = new List<string>();
  List<string> right = new List<string>(); //for each object in array
  foreach (var item in objsArray)
  {
   //get x value
   double x = double.Parse(item["rectangle"]["x"].ToString()); //get width of object detected
   double w = double.Parse(item["rectangle"]["w"].ToString()); //check where the object is located
   if (position(imageWidth, x, w) == "left")
   {
    left.Add(item["object"].ToString());
   }
   if (position(imageWidth, x, w) == "front")
   {
    front.Add(item["object"].ToString());
   }
   if (position(imageWidth, x, w) == "right")
   {
    right.Add(item["object"].ToString());
   }
  }
  //if lists are not empty, create sentence
  if (!(left.Count == 0))
  {
   objectsText = string.Join(",", left) + " to your left, ";
  }
  if (!(front.Count == 0))
  {
   objectsText = objectsText + string.Join(",", front) + " in your front,  ";
  }
  if (!(right.Count == 0))
  {
   objectsText = objectsText + "and " + string.Join(",", right) + " to your right";
  }
 }
 catch
 {
  objectsText = "Couldn't get position data, Please try again !";
 }
 return objectsText;
}
```

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æœ‰â€œä½ç½®â€æ–¹æ³•ã€‚å¦‚å‰æ‰€è¿°ï¼Œè¯¥æ–¹æ³•ç”¨äºè®¡ç®—ç‰¹å®šå¯¹è±¡ç›¸å¯¹äºå›¾åƒä½äºå“ªä¸ªéƒ¨åˆ†ã€‚è¯¥æ–¹æ³•æ¥å—ä¸‰ä¸ªå‚æ•°ï¼Œå³æ•´ä¸ªå›¾åƒçš„å®½åº¦ã€å¯¹è±¡çš„ x è½´èµ·å§‹ä½ç½®å’Œå¯¹è±¡çš„å®½åº¦ã€‚

å›¾åƒåˆ†ä¸ºå·¦ã€å‰ã€å³ä¸‰ä¸ªéƒ¨åˆ†ã€‚å°†å¯¹è±¡çš„å®½åº¦é™¤ä»¥ä¸€åŠï¼Œå¹¶ä¸ x å€¼ç›¸åŠ ï¼Œä»¥è·å¾—å¯¹è±¡ä¸­ç‚¹çš„ x å€¼ã€‚ä½¿ç”¨è¯¥ä¸­ç‚¹ï¼Œå¯ä»¥ç¡®å®šå¯¹è±¡ä½äºå›¾åƒçš„å“ªä¸ªéƒ¨åˆ†ã€‚è¿™æ˜¯ä½¿ç”¨ä¸‹é¢çš„ä»£ç å®Œæˆçš„:

```
public string position(double width, double x, double w)
{
 //divide image to 3 sections vertically and obtain length of one section
 double oneSection = width / 3;//left section will end from oneSection length
 double left = oneSection;//front section end from 2 * oneSection length
 double front = oneSection * 2;//check if object's middle (x+w/2) is in which section
 if ((x + w / 2.0) < left)
 {
  return "left";
 }
 else if ((x + w / 2.0) <= front)
 {
  return "front";
 }
 else
 {
  return "right";
 }
}
```

**SpeechHandler.cs**

æ¥ä¸‹æ¥ï¼Œæˆ‘å°†è®¨è®ºå¤„ç†æ–‡æœ¬åˆ°è¯­éŸ³å’Œè¯­éŸ³åˆ°æ–‡æœ¬åŠŸèƒ½çš„ SpeechHandler.cs è„šæœ¬ã€‚

æ­¤ç±»åŒ…å«ç”¨äº UI æ–‡æœ¬ç»„ä»¶ã€è¯­è¨€ä»£ç å’Œå¸ƒå°”å˜é‡â€œisListeningâ€çš„å˜é‡ã€‚UI æ–‡æœ¬ç»„ä»¶ç”¨äºæ˜¾ç¤ºåº”ç”¨ç¨‹åºæ˜¯å¦åœ¨å¬è¯­éŸ³ã€‚è¿™åªæ˜¯ä¸ºäº†æˆ‘ä»¬çš„æ–¹ä¾¿ï¼Œå› ä¸ºå®ƒå¯¹è§†åŠ›æœ‰éšœç¢çš„äººæ²¡æœ‰ç”¨ã€‚â€œisListeningâ€å˜é‡ç”¨äºè·Ÿè¸ªåº”ç”¨ç¨‹åºä½•æ—¶æ²¡æœ‰ç›‘å¬è¯­éŸ³ï¼Œå¦‚æœæ²¡æœ‰ï¼Œupdate æ–¹æ³•å°†æ£€æŸ¥è¿™ä¸€ç‚¹å¹¶å¯åŠ¨ç›‘å¬è¿‡ç¨‹ã€‚ä»¥ä¸‹æ˜¯ä¸Šè¿°å˜é‡:

```
//UI text
[SerializeField] private Text speechStatus;//language code constant
const string LANG_CODE = "en-US";//variable to know if app is listening to voice
bool isListening = true;
```

å¦‚å‰æ‰€è¿°ï¼Œè¯¥é¡¹ç›®éµå¾ªå•ä¾‹è®¾è®¡æ¨¡å¼ï¼Œå› æ­¤ï¼Œæˆ‘åˆ›å»ºäº†è¯¥ç±»çš„ä¸€ä¸ªå®ä¾‹ï¼Œå¦‚ä¸‹æ‰€ç¤º:

```
private static SpeechHandler instance;public static SpeechHandler Instance
{
 get
 {
  if (instance == null)
  {
   instance = FindObjectOfType<SpeechHandler>();
  }
  return instance;
 }
}
```

é…ç½® TextToSpeech å’Œ SpeechToText è®¾ç½®çš„â€œSetupâ€æ–¹æ³•è®¾ç½®æ‰¬å£°å™¨å’Œæ¥æ”¶å™¨çš„è¯­è¨€ã€éŸ³è°ƒå’Œé€Ÿç‡ã€‚

```
void Setup(string code)
{
 TextToSpeech.instance.Setting(code, 1, 0.8f);
 SpeechToText.instance.Setting(code);
}
```

æ¥ä¸‹æ¥ï¼Œå®šä¹‰ä¸€ä¸ªåä¸ºâ€œStartSpeakingâ€çš„æ–¹æ³•æ¥å¯åŠ¨åº”ç”¨ç¨‹åºæœ—è¯»æ¶ˆæ¯ã€‚

```
public void StartSpeaking(string message)
{
 TextToSpeech.instance.StartSpeak(message);
}
```

æ¥ä¸‹æ¥ï¼Œå®šä¹‰ä¸€ä¸ªå›è°ƒå‡½æ•°æ¥å¤„ç†è®²è¯åœæ­¢æ—¶çš„æ“ä½œã€‚è¿™é‡Œï¼Œæˆ‘å°†â€œisListeningâ€è®¾ç½®ä¸º falseï¼Œè¿™æ · update æ–¹æ³•å°†ä»ä¸‹ä¸€å¸§è°ƒç”¨â€œStartListeningâ€ã€‚

```
public void OnSpeakStop()
{
 //set isListening to False
 isListening = false;
}
```

ä¸‹é¢ç»™å‡ºçš„æ˜¯â€œå¼€å§‹ç›‘å¬â€åŠŸèƒ½ã€‚è¿™é‡Œï¼ŒUI æ–‡æœ¬ç»„ä»¶ä¹Ÿè¢«æ›´æ–°ã€‚

```
public void StartListening()
{
 SpeechToText.instance.StartRecording();
 speechStatus.text = "Listening...";
}
```

ç±»ä¼¼åœ°ï¼ŒStopListening æ–¹æ³•åœæ­¢ç›‘å¬è¯­éŸ³å¹¶æ›´æ–° UI æ–‡æœ¬ç»„ä»¶ã€‚

```
public void StopListening()
{
 SpeechToText.instance.StopRecording();
 speechStatus.text = "Stopped Listening";
}
```

æ¥ä¸‹æ¥æ˜¯â€œOnFinalSpeechResultâ€æ–¹æ³•ï¼Œå®ƒæ ¹æ®è¯†åˆ«çš„å…³é”®å­—å¤„ç†å¯¹æ ‡é¢˜ç±»å®ä¾‹çš„è°ƒç”¨ã€‚å¦‚æœåœ¨ç”¨æˆ·è¯­éŸ³è¾“å…¥ä¸­è¯†åˆ«å‡ºâ€œä½ç½®â€,åˆ™è°ƒç”¨å‚æ•°è®¾ç½®ä¸º false çš„â€œä¿å­˜å›¾åƒâ€åç¨‹(æ„å‘³ç€ç”¨æˆ·ä¸éœ€è¦æè¿°ï¼Œä½†éœ€è¦ä½ç½®æ•°æ®)ã€‚å¦‚æœåœ¨ç”¨æˆ·è¾“å…¥ä¸­æ£€æµ‹åˆ°â€œæ ‡é¢˜â€å…³é”®å­—ï¼Œåˆ™ä¼šå‘ç”Ÿç›¸åçš„æƒ…å†µã€‚å¦‚æœæ²¡æœ‰æ£€æµ‹åˆ°ï¼Œåˆ™å°†â€œisListeningâ€å˜é‡è®¾ç½®ä¸º falseã€‚ä¸‹é¢ç»™å‡ºçš„æ˜¯â€œOnFinalSpeechResultâ€æ–¹æ³•ã€‚

```
void OnFinalSpeechResult(string result)
{
 speechStatus.text = result;try
 {
  //check if 'position' or 'desribe' words in spoken sentence by user
  if (result.ToLower().Contains("placement"))
  {
   //set is Listening to true because otherwise, app will listen to caption spoken by itself from update method
   isListening = true; //stoplistening
   StopListening();//call SaveImage
   StartCoroutine(caption.Instance.SaveImage(false));
  }
  else if (result.ToLower().Contains("caption"))
  {
   //set is Listening to true because otherwise, app will listen to position sentence spoken by itself from update method
   isListening = true; //stoplistening
   StopListening(); //call SaveImage
   StartCoroutine(caption.Instance.SaveImage(true));
  }
  else
  {
   //set isListening to false
   isListening = false;
  }
 }
 catch
 {
 }
}
```

æ¥ä¸‹æ¥ï¼Œâ€œOnFinalSpeechResultâ€å’Œâ€œOnSpeakStopâ€å›è°ƒéƒ½åº”è¯¥æ³¨å†Œåˆ°å„è‡ªçš„ç±»ä¸­ã€‚è¿™æ˜¯åœ¨ start æ–¹æ³•ä¸­å®Œæˆçš„ï¼Œè¯¥æ–¹æ³•è¿˜è°ƒç”¨â€œSetupâ€æ–¹æ³•å’Œâ€œStartListeningâ€æ–¹æ³•ã€‚

```
void Start()
{
 //call setup method
 Setup(LANG_CODE); //register onResultCallback
 SpeechToText.instance.onResultCallback = OnFinalSpeechResult; //register onDoneCallback
 TextToSpeech.instance.onDoneCallback = OnSpeakStop; //start listening to voice
 StartListening();
}
```

æœ€åï¼Œâ€œæ›´æ–°â€æ–¹æ³•æ£€æŸ¥å˜é‡â€œisListeningâ€æ˜¯å¦ä¸ºå‡ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™è°ƒç”¨â€œStartListeningâ€æ–¹æ³•ã€‚

```
void Update()
{
 //if not listening, start listening
 if (!isListening)
 {
  StartListening();
 }
}
```

è¿™å°±å®Œæˆäº†è¿™ä¸ªé¡¹ç›®çš„ç¼–ç ä»»åŠ¡ã€‚

æ¥ä¸‹æ¥ï¼Œåœ¨æ„å»ºåº”ç”¨ç¨‹åºä¹‹å‰ï¼Œéœ€è¦å°†â€œcamera feedâ€raw image å’Œâ€œSpeechStatusâ€æ–‡æœ¬ UI ç»„ä»¶åˆ†åˆ«åˆ†é…ç»™ captionHandler æ¸¸æˆå¯¹è±¡çš„æ ‡é¢˜è„šæœ¬ç»„ä»¶å’Œ SpeechHandler æ¸¸æˆå¯¹è±¡çš„ SpeechHandler è„šæœ¬ã€‚

![](img/fc90fdc8f54f4ee68688292978bf342a.png)

è¿™å°±å®Œæˆäº†è¿™ä¸ªé¡¹ç›®çš„å¼€å‘ã€‚

è¿™æ˜¯åº”ç”¨ç¨‹åºçš„æ¼”ç¤ºã€‚

è¿™ä¸ªé¡¹ç›®åˆ°æ­¤ä¸ºæ­¢ã€‚è¯·è®©æˆ‘çŸ¥é“ä½ çš„åé¦ˆå’Œå»ºè®®ã€‚è°¢è°¢å¤§å®¶ï¼å¹²æ¯ï¼ğŸ˜€