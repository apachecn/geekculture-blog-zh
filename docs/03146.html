<html>
<head>
<title>How to make Pulumi, GitHub Actions, &amp; multi-stage builds work together</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">å¦‚ä½•è®©Pulumiã€GitHubåŠ¨ä½œå’Œå¤šé˜¶æ®µæ„å»ºååŒå·¥ä½œ</h1>
<blockquote>åŸæ–‡ï¼š<a href="https://medium.com/geekculture/pulumi-multi-stage-builds-github-actions-40cfb165f025?source=collection_archive---------18-----------------------#2021-06-01">https://medium.com/geekculture/pulumi-multi-stage-builds-github-actions-40cfb165f025?source=collection_archive---------18-----------------------#2021-06-01</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/4b74ae87e6bbef69f09ac81ae1d4e630.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*GIXZcvoBIuA8XUDD"/></div></div><figcaption class="iq ir et er es is it bd b be z dx">Photo by <a class="ae iu" href="https://unsplash.com/@marcojodoin?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Marc-Olivier Jodoin</a> on <a class="ae iu" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="1417" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj">TLï¼›DR: </strong>ä½¿ç”¨<code class="du jt ju jv jw b">buildx</code>å’Œä¸€äº›é™„åŠ é€‰é¡¹:</p><pre class="jx jy jz ka fd kb jw kc kd aw ke bi"><span id="5bce" class="kf kg hi jw b fi kh ki l kj kk">const image = repo.buildAndPushImage({<br/>  target: 'final_stage',<br/>  cacheFrom: { stages: ['cached_stage_1', 'cached_stage_2'] },<br/>  extraOptions: ['--load'],<br/>  args: { BUILDKIT_INLINE_CACHE: '1' },<br/>})</span></pre><p id="9e40" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj">ç›®å½•</strong></p><ul class=""><li id="8e75" class="kl km hi ix b iy iz jc jd jg kn jk ko jo kp js kq kr ks kt bi translated"><a class="ae iu" href="#5f30" rel="noopener ugc nofollow">ä¸ºä»€ä¹ˆæ˜¯æ™®é²ç±³ï¼Ÿ</a></li><li id="6f8f" class="kl km hi ix b iy ku jc kv jg kw jk kx jo ky js kq kr ks kt bi translated"><a class="ae iu" href="#872a" rel="noopener ugc nofollow">å¤šé˜¶æ®µæ„å»º</a></li><li id="03cc" class="kl km hi ix b iy ku jc kv jg kw jk kx jo ky js kq kr ks kt bi translated"><a class="ae iu" href="#eb7a" rel="noopener ugc nofollow">æ·»åŠ GitHubåŠ¨ä½œ</a></li><li id="ac22" class="kl km hi ix b iy ku jc kv jg kw jk kx jo ky js kq kr ks kt bi translated"><a class="ae iu" href="#613d" rel="noopener ugc nofollow">æ·»åŠ æ™®é²ç±³</a></li></ul></div><div class="ab cl kz la gp lb" role="separator"><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le"/></div><div class="hb hc hd he hf"><p id="6fae" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">æœ€è¿‘ï¼Œå½“æˆ‘ä»¬å°†ä¸€ä¸ªå †æ ˆä»Herokuè¿ç§»åˆ°AWSæ—¶ï¼Œæˆ‘æœ‰æœºä¼šåœ¨Nayyaå¼€å§‹ä½¿ç”¨Pulumiã€‚Pulumiæ˜¯ä¸€ä¸ªåŸºç¡€è®¾æ–½å³ä»£ç (IaC)å¹³å°ï¼Œæˆ‘å¯¹å®ƒæ„Ÿå…´è¶£å·²ç»æœ‰ä¸€æ®µæ—¶é—´äº†ï¼Œå®ƒéå¸¸é€‚åˆæˆ‘ä»¬çš„åŸºç¡€è®¾æ–½/éƒ¨ç½²éœ€æ±‚ã€‚</p><h1 id="5f30" class="lg kg hi bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">ä¸ºä»€ä¹ˆæ˜¯æ™®é²ç±³ï¼Ÿ</h1><p id="3b8e" class="pw-post-body-paragraph iv iw hi ix b iy md ja jb jc me je jf jg mf ji jj jk mg jm jn jo mh jq jr js hb bi translated">ä¸æˆ‘ä½¿ç”¨è¿‡çš„å…¶ä»–IaCå·¥å…·ç›¸æ¯”ï¼Œæˆ‘æ›´å–œæ¬¢Pulumiçš„ä¸€ç‚¹æ˜¯:å¼€å‘äººå‘˜å¯ä»¥ç”¨ç†Ÿæ‚‰çš„ç¼–ç¨‹è¯­è¨€(å¦‚Typescriptæˆ–Python)æ¥å®šä¹‰åŸºç¡€è®¾æ–½ï¼Œè€Œä¸æ˜¯ç”¨ç‰¹å®šäºé¢†åŸŸçš„è¯­è¨€æˆ–æ ‡è®°æ¥ç¼–å†™ã€‚</p><p id="9467" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">ä¸‹é¢æ˜¯åœ¨<strong class="ix hj"> Terraform </strong>ä¸­åˆ›å»ºå‡ ä¸ªIAMç”¨æˆ·çš„æ ·å­:</p><pre class="jx jy jz ka fd kb jw kc kd aw ke bi"><span id="f22c" class="kf kg hi jw b fi kh ki l kj kk">variable "user_names" {<br/>  description = "Create IAM users with these names"<br/>  type        = list(string)<br/>  default     = ["tariq", "ahmir", "kamal"]<br/>}</span><span id="ea12" class="kf kg hi jw b fi mi ki l kj kk">resource "aws_iam_user" "users" {<br/>  for_each = toset(var.user_names)<br/>  name     = each.value<br/>}</span><span id="bcc6" class="kf kg hi jw b fi mi ki l kj kk"># First user = aws_iam_user.users[0]</span></pre><p id="1d70" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">ä¸‹é¢æ˜¯å®ƒåœ¨<strong class="ix hj">æ™®é²ç±³</strong>ä¸­çš„æ ·å­ï¼Œä½¿ç”¨çš„æ˜¯æ‰“å­—ç¨¿:</p><pre class="jx jy jz ka fd kb jw kc kd aw ke bi"><span id="35b5" class="kf kg hi jw b fi kh ki l kj kk">const config = new pulumi.Config()<br/>const usernames = config.requireObject&lt;string[]&gt;('usernames')</span><span id="a2bf" class="kf kg hi jw b fi mi ki l kj kk">const users = usernames.map(name =&gt; new aws.iam.User(name))</span><span id="7085" class="kf kg hi jw b fi mi ki l kj kk">// First user = users[0]</span></pre><p id="27fd" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">Pulumi/Typescriptå¯¹æˆ‘æ¥è¯´ä¸é‚£ä¹ˆå†—é•¿ï¼Œæ›´ç›´è§‚ï¼Œæˆ‘å–œæ¬¢èƒ½å¤Ÿåœ¨IaCä¸­ä½¿ç”¨å¸¸è§çš„ç¼–ç¨‹è¯­è¨€ã€‚åœ¨Nayyaï¼Œæˆ‘ä»¬ä½¿ç”¨äº†Rubyã€Typescript/JS/Nodeã€Pythonå’Œå…¶ä»–è¯­è¨€çš„ç»„åˆï¼Œå¯¹IaCä½¿ç”¨Typescriptæ„Ÿè§‰å¾ˆåˆé€‚ã€‚ğŸš€</p><h1 id="872a" class="lg kg hi bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">æˆ‘ä»¬å¦‚ä½•ä¿æŒDockeræ„å»ºé€Ÿåº¦å¿«ï¼Œå›¾åƒå°ï¼Ÿ</h1><p id="b4a6" class="pw-post-body-paragraph iv iw hi ix b iy md ja jb jc me je jf jg mf ji jj jk mg jm jn jo mh jq jr js hb bi translated">ä¸€ä¸ªå¾ˆå¥½çš„ç­–ç•¥æ˜¯<a class="ae iu" href="https://docs.docker.com/develop/develop-images/multistage-build/" rel="noopener ugc nofollow" target="_blank">å¤šé˜¶æ®µæ„å»º</a>ã€‚åœ¨æœ¬åœ°æ„å»ºå¤šé˜¶æ®µDockerfileæ—¶ï¼Œç¬¬ä¸€æ¬¡æ„å»ºå°†ä¸ºæ„å»ºçš„æ¯ä¸ªé˜¶æ®µç”Ÿæˆä¸€ä¸ªæ˜ åƒï¼Œè¿™äº›æ˜ åƒå°†ç”¨äºç¼“å­˜è¿™äº›å±‚ä»¥ä¾›å°†æ¥æ„å»ºä½¿ç”¨ã€‚</p><p id="d8c2" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">è¿™æ ·ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä¸€ä¸ªé˜¶æ®µæ¥å®‰è£…æˆ‘ä»¬çš„ä¾èµ–é¡¹ï¼Œå¦ä¸€ä¸ªé˜¶æ®µæ¥æ„å»ºèµ„äº§(Webpack)ï¼Œæœ€åä¸€ä¸ªé˜¶æ®µæ¥å¤åˆ¶å‰é¢é˜¶æ®µä¸éœ€è¦çš„æ‰€æœ‰æ–‡ä»¶ã€‚è¿™æ ·ï¼Œå¦‚æœè‡ªä¸Šæ¬¡æ„å»ºä»¥æ¥ä¾èµ–é¡¹æ²¡æœ‰æ”¹å˜ï¼Œä¾èµ–é¡¹é˜¶æ®µå°†è¢«ç¼“å­˜ã€‚å¦‚æœç½‘ç»œæ‰“åŒ…çš„æ–‡ä»¶æ²¡æœ‰æ”¹å˜ï¼Œæ„å»ºèµ„äº§é˜¶æ®µå°†è¢«ç¼“å­˜ã€‚å¦‚æœæ²¡æœ‰æ–‡ä»¶å‘ç”Ÿæ›´æ”¹ï¼Œæœ€ç»ˆé˜¶æ®µä¹Ÿå°†è¢«ç¼“å­˜ã€‚è¿™æœ‰åŠ©äºæˆ‘ä»¬å¿«é€Ÿæ„å»ºï¼</p><p id="f9ef" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">æ­¤å¤–ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä¸€ä¸ªå…¨åŠŸèƒ½çš„åŸºç¡€æ˜ åƒæ¥æ„å»ºæˆ‘ä»¬çš„åº”ç”¨ç¨‹åºï¼Œç„¶åå°†ç”Ÿæˆçš„å·¥ä»¶å¤åˆ¶åˆ°ä¸€ä¸ªæ›´å°çš„åŸºç¡€æ˜ åƒä¸­è¿›è¡Œç”Ÿäº§ã€‚è¿™é‡Œæœ‰ä¸€ä¸ªä¾‹å­<code class="du jt ju jv jw b">Dockerfile</code>:</p><pre class="jx jy jz ka fd kb jw kc kd aw ke bi"><span id="62a7" class="kf kg hi jw b fi kh ki l kj kk"># Large base image with build tools, caches our dependencies:<br/>FROM node as deps<br/>RUN yarn install</span><span id="97e3" class="kf kg hi jw b fi mi ki l kj kk"># Build stage:<br/>FROM deps as build<br/>RUN yarn build</span><span id="99fa" class="kf kg hi jw b fi mi ki l kj kk"># Small base image, copy artifacts:<br/>FROM node:slim as production<br/>COPY --from=build ./node_modules .<br/>COPY --from=build ./build .</span></pre><p id="12ce" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj"> âš ï¸é—®é¢˜âš ï¸ </strong>ä¸å¹¸çš„æ˜¯ï¼Œå½“æˆ‘ä»¬ä½¿ç”¨äº‘CIå¹³å°æ„å»ºæˆ‘ä»¬çš„æ˜ åƒæ—¶ï¼Œèˆå°æ˜ åƒä¸ä¼šåœ¨æœ¬åœ°ç¼“å­˜ï¼Œå› ä¸ºrunneræ¯æ¬¡éƒ½æ˜¯ä»å¤´å¼€å§‹ï¼›æ¯æ¬¡æ„å»ºå¼€å§‹æ—¶éƒ½æ²¡æœ‰æœ¬åœ°å›¾åƒç¼“å­˜ï¼</p><h1 id="eb7a" class="lg kg hi bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">è§£å†³ä»…ä½¿ç”¨GitHubåŠ¨ä½œæ—¶çš„é—®é¢˜</h1><p id="a14a" class="pw-post-body-paragraph iv iw hi ix b iy md ja jb jc me je jf jg mf ji jj jk mg jm jn jo mh jq jr js hb bi translated">å¦‚æœæ‚¨åœ¨GitHubåŠ¨ä½œä¸Šæ„å»ºDockerå›¾åƒè€Œä¸ä½¿ç”¨Pulumiï¼Œæœ‰ä¸€ä¸ªç®€å•çš„è§£å†³æ–¹æ³•:Dockerå¸¦ç¼“å­˜æ„å»ºåŠ¨ä½œ<a class="ae iu" href="https://github.com/whoan/docker-build-with-cache-action" rel="noopener ugc nofollow" target="_blank">ã€‚æˆ‘ä½¿ç”¨ECRä½œä¸ºæˆ‘çš„æ³¨å†Œè¡¨ï¼Œæ‰€ä»¥åœ¨GitHub Actionså·¥ä½œæµæ–‡ä»¶ä¸­ï¼Œå®ƒçœ‹èµ·æ¥åƒè¿™æ ·:</a></p><pre class="jx jy jz ka fd kb jw kc kd aw ke bi"><span id="49e9" class="kf kg hi jw b fi kh ki l kj kk">jobs:<br/>  job_name:<br/>    steps:<br/>      (...)</span><span id="e539" class="kf kg hi jw b fi mi ki l kj kk">    - name: Configure AWS credentials<br/>      uses: aws-actions/configure-aws-credentials@v1<br/>      with:<br/>        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}<br/>        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}<br/>        aws-region: ${{ env.AWS_REGION }}</span><span id="a324" class="kf kg hi jw b fi mi ki l kj kk">    - name: Login to Amazon ECR<br/>      id: login-ecr<br/>      uses: aws-actions/amazon-ecr-login@v1</span><span id="afeb" class="kf kg hi jw b fi mi ki l kj kk">    - name: Build and push (with cache)<br/>      id: build-and-push-with-cache<br/>      uses: <strong class="jw hj">whoan/docker-build-with-cache-action</strong>@v5<br/>      with:<br/>        registry: ${{ steps.login-ecr.outputs.registry }}<br/>        image_name: image_name_here<br/>        image_tag: ${{ github.sha }}-production</span></pre><p id="347d" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">è¿™å°†åˆ›å»ºECRå­˜å‚¨åº“<code class="du jt ju jv jw b">image_name_here</code>å’Œ<code class="du jt ju jv jw b">image_name_here-stages</code>(å¦‚æœå®ƒä»¬è¿˜ä¸å­˜åœ¨çš„è¯)ã€‚å‰è€…å°†ç”¨äºä¸Šä¼ æœ€ç»ˆçš„èˆå°æ„å»ºå›¾åƒï¼Œåè€…å°†ç”¨äºä¸Šä¼ èˆå°å›¾åƒã€‚<code class="du jt ju jv jw b">whoan/docker-build-with-cache-action@v5</code>åŠ¨ä½œé¦–å…ˆæå–ç°æœ‰çš„èˆå°å›¾åƒå’Œæœ€ç»ˆå›¾åƒï¼Œç„¶åä½¿ç”¨è¿™äº›å›¾åƒè¿è¡Œdocker buildè¿›è¡Œç¼“å­˜ï¼Œç„¶åå°†æœ€ç»ˆçš„æœ€ç»ˆå›¾åƒå’Œèˆå°å›¾åƒæ¨å›åˆ°è¿™äº›å­˜å‚¨åº“ä¸­ã€‚</p><p id="74be" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj">ä½†æ˜¯ï¼Œå¦‚æœæˆ‘ä»¬ä½¿ç”¨Pulumiï¼ŒDockeræ„å»ºåº”è¯¥åœ¨Pulumiä¸­å®šä¹‰ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸èƒ½ä½¿ç”¨ä¸Šé¢çš„æ–¹æ³•ã€‚</strong></p><h1 id="613d" class="lg kg hi bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">âœ¨è§£å†³äº†åœ¨GitHub Actions âœ¨ä¸Šä½¿ç”¨Pulumiçš„é—®é¢˜</h1><p id="0380" class="pw-post-body-paragraph iv iw hi ix b iy md ja jb jc me je jf jg mf ji jj jk mg jm jn jo mh jq jr js hb bi translated">æ–¹ä¾¿çš„æ˜¯ï¼ŒPulumiæœ‰ä¸€ä¸ª<a class="ae iu" href="https://github.com/pulumi/actions" rel="noopener ugc nofollow" target="_blank"> GithubåŠ¨ä½œ</a>ï¼Œå¤„ç†CLIçš„å®‰è£…å’Œè¿è¡Œ<code class="du jt ju jv jw b">pulumi up</code>ã€‚æˆ‘ä»¬å°†ä½¿ç”¨å®ƒåœ¨GitHubåŠ¨ä½œå·¥ä½œæµä¸­è¿è¡ŒPulumiã€‚</p><p id="3090" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">åœ¨Pulumiä¸­ï¼Œæˆ‘ä»¬å¯ä»¥åˆ›å»ºECRå­˜å‚¨åº“å’Œæ¨é€åˆ°è¯¥å­˜å‚¨åº“çš„å›¾åƒã€‚å½“æˆ‘ç¬¬ä¸€æ¬¡å°è¯•è¿™ç§æ–¹æ³•æ—¶ï¼Œæˆ‘éµå¾ªæ–‡æ¡£å¹¶å¾—å‡ºäº†è¿™ä¸ªç»“è®º:</p><pre class="jx jy jz ka fd kb jw kc kd aw ke bi"><span id="b98b" class="kf kg hi jw b fi kh ki l kj kk">// DO NOT USE:</span><span id="ec96" class="kf kg hi jw b fi mi ki l kj kk">const repo = new awsx.ecr.Repository('app_name-stack_name')</span><span id="a4e6" class="kf kg hi jw b fi mi ki l kj kk">const image = repo.buildAndPushImage({<br/>  target: 'production',<br/>  cacheFrom: { stages: ['deps', 'build', 'production'] },<br/>})</span></pre><p id="6a25" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">å½“æˆ‘åœ¨æœ¬åœ°è¿è¡Œ<code class="du jt ju jv jw b">pulumi up</code>æ—¶ï¼Œè¿™éå¸¸æœ‰æ•ˆï¼å®ƒæ‹‰ä¸‹<code class="du jt ju jv jw b">image_name:deps</code>ã€<code class="du jt ju jv jw b">image_name:build</code>å’Œ<code class="du jt ju jv jw b">image_name:production</code>ï¼Œç”¨ç¼“å­˜æ„å»ºå›¾åƒï¼Œç„¶åæ¨é€æ–°çš„å›¾åƒã€‚æ³¨æ„:è¿™ç§æ–¹æ³•ä¸åƒ<code class="du jt ju jv jw b">whoan/docker-build-with-cache-action</code>é‚£æ ·ä¸ºé˜¶æ®µåˆ›å»ºå•ç‹¬çš„å­˜å‚¨åº“ï¼Œè€Œæ˜¯ä¸ºä¸åŒçš„é˜¶æ®µä½¿ç”¨ä¸åŒçš„æ ‡ç­¾ã€‚</p><p id="d017" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj">ä¸å¹¸çš„æ˜¯ï¼Œå½“æˆ‘åœ¨GitHub Actionså·¥ä½œæµä¸­è¿è¡ŒPulumiå †æ ˆæ›´æ–°æ—¶ï¼Œæˆ‘é‡åˆ°äº†å‡ ä¸ªé—®é¢˜:</strong></p><ol class=""><li id="764f" class="kl km hi ix b iy iz jc jd jg kn jk ko jo kp js mj kr ks kt bi translated">åœ¨dockeræ„å»ºä¹‹å‰ï¼Œå·²ç»ä»ECSä¸­æ­£ç¡®æå–äº†é˜¶æ®µæ˜ åƒï¼Œä½†æ˜¯è¿™äº›æ˜ åƒæ²¡æœ‰ç”¨äºç¼“å­˜ï¼Œå› æ­¤å³ä½¿æ¯ä¸ªé˜¶æ®µéƒ½åº”è¯¥è¢«ç¼“å­˜ï¼Œä¹Ÿè¦é‡æ–°æ„å»ºã€‚</li><li id="12c9" class="kl km hi ix b iy ku jc kv jg kw jk kx jo ky js mj kr ks kt bi translated">è¿™äº›é˜¶æ®µç”šè‡³æ²¡æœ‰åœ¨æœ¬åœ°æ­£ç¡®ç¼“å­˜ï¼Œæ‰€ä»¥å¯¹äºæˆ‘çš„3ä¸ªé˜¶æ®µï¼Œå®ƒå°†å†æ¬¡é€’å½’æ„å»ºæ¯ä¸ªä¾èµ–é˜¶æ®µï¼Œè€Œæ²¡æœ‰ç¼“å­˜ï¼äºæ˜¯å®ƒå»ºé€ äº†<code class="du jt ju jv jw b">deps</code>ï¼Œç„¶åä½œä¸º<code class="du jt ju jv jw b">build</code>çš„ä¸€éƒ¨åˆ†å†æ¬¡å»ºé€ äº†<code class="du jt ju jv jw b">deps</code>ï¼Œç„¶åå»ºé€ äº†<code class="du jt ju jv jw b">build</code>ï¼Œç„¶åä½œä¸º<code class="du jt ju jv jw b">production</code>çš„ä¸€éƒ¨åˆ†å†æ¬¡å»ºé€ äº†<code class="du jt ju jv jw b">deps</code>å’Œ<code class="du jt ju jv jw b">build</code>ï¼Œç„¶åå»ºé€ äº†<code class="du jt ju jv jw b">production</code>ã€‚ä¸€ä¸ªå®Œå…¨ç¼“å­˜çš„æ„å»ºåº”è¯¥ä¸åˆ°ä¸€åˆ†é’Ÿâ€”â€”æ­£å¥½æ˜¯æå–æ‰€æœ‰å±‚å¹¶ç¡®è®¤æ¯ä¸€æ­¥éƒ½å¯ä»¥ç¼“å­˜çš„æ—¶é—´â€”â€”è¿™èŠ±è´¹äº†<strong class="ix hj"> 30åˆ†é’Ÿ</strong>ï¼ğŸ˜±</li></ol><p id="327d" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">æ ¹æ®Pulumiç¤¾åŒºSlackçš„ä¸€äº›å»ºè®®ï¼Œæˆ‘å°è¯•ç”¨docker/setup-buildx-action å°†Buildx æ·»åŠ åˆ°æˆ‘çš„GitHub Actionæ„å»ºç¯å¢ƒä¸­ã€‚æˆ‘é€‰æ‹©ä½¿ç”¨<code class="du jt ju jv jw b">docker</code>æ„å»ºé©±åŠ¨ç¨‹åºï¼Œè€Œä¸æ˜¯é»˜è®¤çš„<code class="du jt ju jv jw b">buildx</code>é©±åŠ¨ç¨‹åº<code class="du jt ju jv jw b">docker-container</code>ï¼Œä»¥ä¾¿æ›´å¥½åœ°ä¸Pulumiäº’æ“ä½œã€‚è¯¥æ“ä½œå¦‚ä¸‹æ‰€ç¤º:</p><pre class="jx jy jz ka fd kb jw kc kd aw ke bi"><span id="a899" class="kf kg hi jw b fi kh ki l kj kk">      - uses: docker/setup-buildx-action@v1<br/>        with:<br/>          install: true<br/>          driver: docker<br/>          buildkitd-flags: --debug</span></pre><p id="97b0" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">è¿™æ˜¯æœç€æ­£ç¡®æ–¹å‘è¿ˆå‡ºçš„ä¸€æ­¥ï¼Œä½†æ˜¯æˆ‘éœ€è¦åœ¨Pulumiçš„<code class="du jt ju jv jw b">docker build</code>è°ƒç”¨ä¸­æ·»åŠ <code class="du jt ju jv jw b">--load</code>é€‰é¡¹ã€‚è¿™æ˜¯å¿…è¦çš„ï¼Œå› ä¸ºé»˜è®¤æƒ…å†µä¸‹ï¼Œ<code class="du jt ju jv jw b">buildx</code>ä¸ä¼šå°†æ„å»ºçš„å›¾åƒå­˜å‚¨åœ¨<code class="du jt ju jv jw b">docker images</code>æœ¬åœ°ç¼“å­˜ä¸­:</p><pre class="jx jy jz ka fd kb jw kc kd aw ke bi"><span id="fb3a" class="kf kg hi jw b fi kh ki l kj kk">const image = repo.buildAndPushImage({<br/>  target: 'production',<br/>  cacheFrom: { stages: ['deps', 'build', 'production'] },<br/>  extraOptions: ['--load'],<br/>})</span></pre><p id="e7ab" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">ä¿®å¤äº†é—®é¢˜2â€”â€”ç–¯ç‹‚çš„é€’å½’æ„å»ºä¸å†æ˜¯ä¸€ä¸ªé—®é¢˜ã€‚ç„¶è€Œï¼Œç¼“å­˜ä»ç„¶æ²¡æœ‰æ­£å¸¸å·¥ä½œï¼Œå› ä¸º<code class="du jt ju jv jw b">docker</code>æ„å»ºé©±åŠ¨ç¨‹åºéœ€è¦<code class="du jt ju jv jw b">BUILDKIT_INLINE_CACHE=1</code>è¢«è®¾ç½®ä¸ºæ­£ç¡®å†…è”æ¯ä¸ªé˜¶æ®µçš„ç¼“å­˜ã€‚æ·»åŠ äº†è¿™ä¸ªé€‰é¡¹åï¼Œæ„å»ºç¼“å­˜å°±åƒé¢„æœŸçš„é‚£æ ·å·¥ä½œäº†</p><p id="7fa9" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">æˆ‘è¿˜ä»<code class="du jt ju jv jw b">cacheFrom.stages</code>æ•°ç»„ä¸­åˆ é™¤äº†ç›®æ ‡é˜¶æ®µï¼Œå› ä¸ºè¿™ç»™æµç¨‹å¢åŠ äº†ä¸€ä¸ªä¸å¿…è¦çš„æ­¥éª¤ã€‚</p><p id="b4a5" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">æœ€åï¼Œæˆ‘æ·»åŠ äº†ä¸€ä¸ªæ£€æŸ¥æ¥ç¡®ä¿<code class="du jt ju jv jw b">buildx</code>è¢«å¯ç”¨ï¼Œè¿™æ ·æœ¬åœ°è¿è¡Œ<code class="du jt ju jv jw b">pulumi up</code>å°±ä¸ä¼šå¤±è´¥:</p><pre class="jx jy jz ka fd kb jw kc kd aw ke bi"><span id="b754" class="kf kg hi jw b fi kh ki l kj kk">import { spawnSync, SpawnSyncReturns } from 'child_process'</span><span id="39f1" class="kf kg hi jw b fi mi ki l kj kk">const cmd = (input: string): SpawnSyncReturns&lt;string&gt; =&gt; {<br/>  const [command, ...args] = input.split(' ').filter((str) =&gt; str)<br/>  const result = spawnSync(command, args, {<br/>    encoding: 'utf-8',<br/>  }) as unknown as SpawnSyncReturns&lt;string&gt;</span><span id="9cef" class="kf kg hi jw b fi mi ki l kj kk">  if (result.status !== 0) {<br/>    throw new Error(result.stderr)<br/>  }</span><span id="8696" class="kf kg hi jw b fi mi ki l kj kk">  return result<br/>}</span><span id="23e0" class="kf kg hi jw b fi mi ki l kj kk">export const checkForBuildx = () =&gt; {<br/>  if (!cmd('docker build --help').stdout.includes('buildx')) {<br/>    throw new Error(<br/>      'Buildx must be enabled! Please run: docker buildx install'<br/>    )<br/>  }<br/>}</span></pre><p id="503f" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">è¿™æ˜¯æœ€ç»ˆçš„å·¥ä½œä»£ç :</p><pre class="jx jy jz ka fd kb jw kc kd aw ke bi"><span id="595a" class="kf kg hi jw b fi kh ki l kj kk">checkForBuildx()</span><span id="6e1b" class="kf kg hi jw b fi mi ki l kj kk">const image = repo.buildAndPushImage({<br/>  target: 'production',<br/>  cacheFrom: { stages: ['deps', 'build'] },<br/>  extraOptions: ['--load'],<br/>  args: { BUILDKIT_INLINE_CACHE: '1' },<br/>})</span></pre><p id="9e11" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">æ„Ÿè°¢é˜…è¯»ï¼</p><p id="f6c9" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">æƒ³åŠ å…¥ä¸€ä¸ªå¿«é€Ÿå‘å±•çš„å……æ»¡æ¿€æƒ…çš„å·¥ç¨‹å¸ˆå›¢é˜Ÿå—ï¼Ÿ<a class="ae iu" href="https://nayya.com" rel="noopener ugc nofollow" target="_blank"> Nayya </a>è¸ä¸Šäº†è®©æ•°ç™¾ä¸‡å®¶åº­åšå‡ºæ›´æ˜æ™ºçš„å¥åº·ã€ä¿é™©å’Œè´¢åŠ¡å†³ç­–çš„æ—…ç¨‹â€”â€”æ¥å§<a class="ae iu" href="https://nayya.com/careers" rel="noopener ugc nofollow" target="_blank">åŠ å…¥æˆ‘ä»¬çš„è¡Œåˆ—</a>ï¼</p></div></div>    
</body>
</html>